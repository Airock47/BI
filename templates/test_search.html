<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœå°‹åŠŸèƒ½æ¸¬è©¦</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .console-log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>ğŸ” æœå°‹åŠŸèƒ½æ¸¬è©¦</h2>
        
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label for="testKeyword" class="form-label">æœå°‹é—œéµå­—</label>
                    <input type="text" id="testKeyword" class="form-control" placeholder="è¼¸å…¥æœå°‹é—œéµå­—" value="å˜‰ç¾©å¸‚è¥¿å€æ¾æ±Ÿä¸‰è¡—129è™Ÿ">
                </div>
                
                <button onclick="testSearch()" class="btn btn-primary">ğŸ” æ¸¬è©¦æœå°‹</button>
                <button onclick="clearLog()" class="btn btn-secondary ms-2">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
                
                <div id="result" class="mt-4"></div>
            </div>
            
            <div class="col-md-4">
                <h5>ğŸ“‹ æ¸¬è©¦æ—¥èªŒ</h5>
                <div id="console" class="console-log"></div>
            </div>
        </div>
    </div>

    <script>
        function log(message) {
            const console = document.getElementById('console');
            const time = new Date().toLocaleTimeString();
            console.innerHTML += `[${time}] ${message}<br>`;
            console.scrollTop = console.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('console').innerHTML = '';
        }
        
        async function testSearch() {
            const keyword = document.getElementById('testKeyword').value;
            const resultDiv = document.getElementById('result');
            
            log('ğŸš€ é–‹å§‹æœå°‹æ¸¬è©¦');
            log(`é—œéµå­—: ${keyword}`);
            
            resultDiv.innerHTML = '<div class="alert alert-info">ğŸ”„ æœå°‹ä¸­...</div>';
            
            try {
                // ä½¿ç”¨ç›¸å°è·¯å¾‘ï¼Œé¿å… CORS å•é¡Œ
                const url = `/sales_info/search?keyword=${encodeURIComponent(keyword)}`;
                log(`è«‹æ±‚URL: ${url}`);
                
                const response = await fetch(url);
                log(`å›æ‡‰ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                log(`âœ… æˆåŠŸå–å¾—è³‡æ–™: ${data.length} ç­†`);
                
                if (data.error) {
                    log(`âŒ API éŒ¯èª¤: ${data.error}`);
                    resultDiv.innerHTML = `<div class="alert alert-danger">éŒ¯èª¤: ${data.error}</div>`;
                    return;
                }
                
                if (data.length === 0) {
                    log('âš ï¸ æ²’æœ‰æ‰¾åˆ°è³‡æ–™');
                    resultDiv.innerHTML = '<div class="alert alert-warning">æ²’æœ‰æ‰¾åˆ°è³‡æ–™</div>';
                    return;
                }
                
                // é¡¯ç¤ºçµæœ
                log('ğŸ“Š é–‹å§‹æ¸²æŸ“çµæœ');
                let html = `<div class="alert alert-success">âœ… æ‰¾åˆ° ${data.length} ç­†è³‡æ–™</div>`;
                html += '<div class="table-responsive">';
                html += '<table class="table table-bordered table-striped">';
                html += '<thead class="table-dark"><tr><th>é¡å‹</th><th>å®¢æˆ¶åç¨±</th><th>åœ°å€</th><th>æ—¥æœŸ</th><th>è©³æƒ…</th></tr></thead>';
                html += '<tbody>';
                
                data.forEach((item, index) => {
                    const d = item.data;
                    const typeMap = {
                        'customer': { name: 'å®¢æˆ¶è³‡æ–™', class: 'bg-info' },
                        'sales': { name: 'éŠ·å”®', class: 'bg-primary' },
                        'repair': { name: 'ç¶­ä¿®', class: 'bg-success' },
                        'custody': { name: 'å¯„å€‰å‡ºè²¨', class: 'bg-warning text-dark' }
                    };
                    
                    const typeInfo = typeMap[item.type] || { name: item.type, class: 'bg-secondary' };
                    
                    html += `<tr>
                        <td><span class="badge ${typeInfo.class}">${typeInfo.name}</span></td>
                        <td>${d.å®¢æˆ¶åç¨± || ''}</td>
                        <td>${d.è¯çµ¡åœ°å€ || d.é€è²¨åœ°å€ || d.æœå‹™åœ°å€ || ''}</td>
                        <td>${d.ç™¼è²¨æ—¥æœŸ || d.å–®æ“šæ—¥æœŸ || d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || ''}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showDetails(${index})">
                                ğŸ“‹ è©³æƒ…
                            </button>
                        </td>
                    </tr>`;
                });
                
                html += '</tbody></table></div>';
                
                // å„²å­˜è³‡æ–™ä¾›è©³æƒ…æŸ¥çœ‹ä½¿ç”¨
                window.searchResults = data;
                
                resultDiv.innerHTML = html;
                log('âœ… çµæœæ¸²æŸ“å®Œæˆ');
                
            } catch (error) {
                log(`âŒ æœå°‹å¤±æ•—: ${error.message}`);
                resultDiv.innerHTML = `<div class="alert alert-danger">âŒ æœå°‹å¤±æ•—: ${error.message}</div>`;
            }
        }
        
        function showDetails(index) {
            const item = window.searchResults[index];
            if (!item) return;
            
            const data = item.data;
            let details = '<h6>ğŸ“‹ è©³ç´°è³‡æ–™</h6><table class="table table-sm">';
            
            for (const [key, value] of Object.entries(data)) {
                if (key !== 'type' && value) {
                    details += `<tr><td><strong>${key}:</strong></td><td>${value}</td></tr>`;
                }
            }
            
            details += '</table>';
            
            // ä½¿ç”¨ Bootstrap Modal é¡¯ç¤ºè©³æƒ…
            const modalHtml = `
                <div class="modal fade" id="detailModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">è©³ç´°è³‡æ–™ - ${item.type}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">${details}</div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é—œé–‰</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤èˆŠçš„ modal
            const oldModal = document.getElementById('detailModal');
            if (oldModal) oldModal.remove();
            
            // æ·»åŠ æ–°çš„ modal
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // é¡¯ç¤º modal
            const modal = new bootstrap.Modal(document.getElementById('detailModal'));
            modal.show();
        }
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•æ¸¬è©¦
        window.onload = function() {
            log('ğŸ“± é é¢è¼‰å…¥å®Œæˆ');
            log('ğŸ”§ æº–å‚™é€²è¡Œæœå°‹æ¸¬è©¦');
        };
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
