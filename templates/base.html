<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}BI 系統{% endblock %}</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    .content-wrapper {
      padding: 20px;
    }
  </style>
</head>

<body>

  <!-- 主要內容 -->
  <div class="content-wrapper">
    {% block content %}{% endblock %}
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  {% block scripts %}{% endblock %}
  <script>
    (function () {
      let notificationPermissionRequest;

      function ensureNotificationPermission() {
        if (!("Notification" in window)) {
          return Promise.resolve(false);
        }
        if (Notification.permission === "granted") {
          return Promise.resolve(true);
        }
        if (Notification.permission === "denied") {
          return Promise.resolve(false);
        }
        if (!notificationPermissionRequest) {
          notificationPermissionRequest = Notification.requestPermission().then((result) => result === "granted");
        }
        return notificationPermissionRequest;
      }

      function showCtiNotification(payload) {
        ensureNotificationPermission().then((granted) => {
          if (!granted) {
            console.warn('CTI notification skipped - permission not granted');
            return;
          }
          const phone = payload.phone || '';
          const postal = payload.postalCode || '';
          const custId = payload.customerId || '';
          const lines = [
            phone ? `電話: ${phone}` : null,
            postal ? `郵遞區號: ${postal}` : null,
            custId ? `客戶ID: ${custId}` : null,
          ].filter(Boolean);
          const body = lines.length > 0 ? lines.join('
') : '有新的來電通知';
            try {
            const notification = new Notification('來電通知', {
              body,
              tag: payload.confID || payload.key || 'cti-pop',
              data: payload,
              renotify: true,
            });
            notification.onclick = () => {
              window.focus();
              if (payload.links && payload.links.crm) {
                window.location.href = payload.links.crm;
              }
            };
          } catch (err) {
            console.warn('CTI notification failed', err);
          }
        });
      }

      ensureNotificationPermission();

      try {
        // Open SSE after DOM ready if user is logged in (server will redirect if not)
        const es = new EventSource('/sse/notifications');
        es.addEventListener('ping', function (ev) { /* keepalive */ });
        es.onmessage = function (ev) {
          try {
            const msg = JSON.parse(ev.data || '{}');
            if (msg && msg.type === 'CTI_POP') {
              console.log('[CTI]', msg);
              showCtiNotification(msg);
              if (msg.links && msg.links.crm) {
                // Optional: open CRM page automatically if desired
                // window.open(msg.links.crm, '_blank');
              }
            }
          } catch (e) { console.warn('CTI parse fail', e); }
        };
        es.onerror = function () { /* network errors are expected on reload */ };
      } catch (e) { console.warn('SSE init error', e); }
    })();
  </script>
</body>

</html>