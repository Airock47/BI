<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>å‡ºè²¨ç¶­ä¿®è³‡æ–™æŸ¥è©¢ç³»çµ± v2.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    :root {
      --primary-color: #2c3e50;
      --secondary-color: #34495e;
      --accent-color: #3498db;
      --light-bg: #f8f9fa;
      --border-color: #e9ecef;
    }

    body {
      background-color: var(--light-bg);
      color: var(--primary-color);
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
    }

    .page-header {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      padding: 2rem 0;
      text-align: center;
    }

    .search-form {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin: 2rem auto;
      max-width: 800px;
    }

    .search-input {
      padding: 1rem;
      font-size: 1.1rem;
    }

    .search-btn {
      background-color: var(--accent-color);
      color: white;
    }

    .result-container,
    .detail-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-top: 2rem;
    }

    .table td {
      white-space: nowrap;
      vertical-align: middle;
    }

    .å®¢æˆ¶åç¨±æ¬„,
    .åœ°å€æ¬„,
    .å‚™è¨»æ¬„ {
      white-space: normal !important;
      word-break: break-word;
    }

    .å‚™è¨»æ¬„ {
      max-width: 300px;
    }

    .åœ°å€æ¬„ {
      max-width: 200px;
    }

    .å®¢æˆ¶åç¨±æ¬„ {
      max-width: 150px;
    }

    .total-row {
      background-color: var(--primary-color);
      color: white;
      font-weight: bold;
    }

    .hidden {
      display: none !important;
    }

    .multiline-finish {
      display: inline-block;
      max-width: 100%;
      white-space: pre-line;
      word-break: break-all;
      line-break: anywhere;
    }

    /* è¡¨æ ¼æ¨£å¼å„ªåŒ– */
    .result-container {
      margin-top: 2rem;
      width: 100%;
      overflow-x: auto;
    }

    .table {
      word-break: break-word;
      table-layout: fixed;
      width: 100%;
      margin-bottom: 0;
    }

    .table td,
    .table th {
      word-wrap: break-word !important;
      white-space: normal !important;
      vertical-align: top;
      padding: 8px;
      overflow-wrap: break-word;
    }

    /* ç¢ºä¿å®¹å™¨ä½¿ç”¨å…¨å¯¬åº¦ */
    .container-fluid {
      max-width: 100%;
      padding-left: 8px;
      padding-right: 8px;
    }

    /* æ‰‹æ©ŸéŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
      .page-header h1 {
        font-size: 1.5rem;
      }

      .search-form {
        padding: 1rem;
        margin: 1rem auto;
      }

      .search-input {
        padding: 0.75rem;
        font-size: 1rem;
      }

      /* æ‰‹æ©Ÿç‰ˆå¡ç‰‡å¼é¡¯ç¤º */
      .mobile-card-view {
        display: block !important;
      }

      .desktop-table-view {
        display: none !important;
      }

      .result-card {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 1rem;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #eee;
      }

      .card-type {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: bold;
      }

      .card-doc-no {
        font-size: 0.9rem;
        color: #666;
        font-weight: 500;
      }

      .card-body {
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .card-row {
        display: flex;
        margin-bottom: 0.5rem;
        align-items: flex-start;
      }

      .card-label {
        font-weight: 600;
        color: #495057;
        min-width: 70px;
        margin-right: 0.5rem;
        flex-shrink: 0;
      }

      .card-value {
        color: #212529;
        word-break: break-word;
        flex: 1;
      }

      .card-actions {
        margin-top: 0.75rem;
        padding-top: 0.5rem;
        border-top: 1px solid #eee;
        text-align: center;
      }

      .card-actions .btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }

      /* æ‰‹æ©Ÿç‰ˆç¯©é¸å™¨ */
      .mobile-filters {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .filter-group {
        margin-bottom: 0.75rem;
      }

      .filter-group label {
        font-size: 0.9rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.25rem;
        display: block;
      }

      .filter-group input,
      .filter-group select {
        font-size: 0.9rem;
        padding: 0.5rem;
      }

      .filter-actions {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        margin-top: 1rem;
      }

      .filter-actions .btn {
        flex: 1;
        font-size: 0.9rem;
        padding: 0.5rem;
      }

      /* æ‰‹æ©Ÿç‰ˆæ˜ç´°é¡¯ç¤º */
      .mobile-detail-container {
        animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          max-height: 0;
          overflow: hidden;
        }

        to {
          opacity: 1;
          max-height: 500px;
          overflow: visible;
        }
      }

      .mobile-detail-container h5 {
        font-size: 1rem;
        margin-bottom: 0.75rem;
        color: #495057;
      }

      .mobile-detail-container .table {
        background-color: white;
        border-radius: 4px;
      }

      .mobile-detail-container .table th {
        background-color: #e9ecef;
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
      }

      .mobile-detail-container .table td {
        font-size: 0.75rem;
        padding: 0.5rem 0.25rem;
        word-break: break-word;
      }
    }

    /* æ¡Œé¢ç‰ˆä¿æŒè¡¨æ ¼é¡¯ç¤º */
    @media (min-width: 769px) {
      .mobile-card-view {
        display: none !important;
      }

      .desktop-table-view {
        display: block !important;
      }
    }
  </style>
</head>

<body>
  <div class="page-header">
    <h1>å‡ºè²¨ç¶­ä¿®å®¢æˆ¶è³‡æ–™æŸ¥è©¢ç³»çµ±</h1>
  </div>

  <div class="container-fluid px-2">
    <div class="search-form">
      <form id="searchForm">
        <div class="input-group">
          <input type="text" id="searchInput" class="form-control search-input"
            placeholder="è«‹è¼¸å…¥é—œéµå­—ï¼ˆå®¢æˆ¶åç¨±ã€åœ°å€ã€é›»è©±ã€å®¢æˆ¶ä»£ç¢¼ã€è¯çµ¡äººï¼‰" required />
          <button type="submit" class="btn search-btn">
            <i class="bi bi-search me-2"></i>æœå°‹
          </button>
        </div>
      </form>
    </div>

    <div id="results" class="result-container hidden">
      <div id="loading" class="text-center py-5 hidden">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div id="error" class="alert alert-danger hidden"></div>

      <!-- çµæœçµ±è¨ˆ -->
      <div id="resultSummary" class="mb-2 hidden">
        <small class="text-muted">
          <span id="filterStatus">é¡¯ç¤ºå…¨éƒ¨çµæœ</span> |
          <span id="resultCount">å…± 0 ç­†</span>
        </small>
      </div>

      <!-- æ‰‹æ©Ÿç‰ˆç¯©é¸å™¨ -->
      <div id="mobileFilters" class="mobile-filters d-block d-md-none hidden">
        <div class="row">
          <div class="col-6">
            <div class="filter-group">
              <label>é¡å‹</label>
              <select id="mobileTypeFilter" class="form-select">
                <option value="">å…¨éƒ¨</option>
                <option value="customer">å®¢æˆ¶è³‡æ–™</option>
                <option value="sales">éŠ·å”®</option>
                <option value="repair">ç¶­ä¿®</option>
                <option value="custody">å¯„å€‰å‡ºè²¨</option>
              </select>
            </div>
          </div>
          <div class="col-6">
            <div class="filter-group">
              <label>å®¢æˆ¶åç¨±</label>
              <input type="text" id="mobileCustomerNameFilter" class="form-control" placeholder="å®¢æˆ¶åç¨±">
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-6">
            <div class="filter-group">
              <label>èµ·å§‹æ—¥æœŸ</label>
              <input type="date" id="mobileDateFromFilter" class="form-control">
            </div>
          </div>
          <div class="col-6">
            <div class="filter-group">
              <label>çµæŸæ—¥æœŸ</label>
              <input type="date" id="mobileDateToFilter" class="form-control">
            </div>
          </div>
        </div>
        <div class="filter-actions">
          <button type="button" id="mobileClearFilters" class="btn btn-outline-secondary">
            <i class="bi bi-funnel"></i> æ¸…é™¤ç¯©é¸
          </button>
          <button type="button" id="mobileResetFilters" class="btn btn-outline-danger">
            <i class="bi bi-x-circle"></i> é‡ç½®
          </button>
        </div>
      </div>

      <!-- æ¡Œé¢ç‰ˆè¡¨æ ¼é¡¯ç¤º -->
      <div id="desktopResults" class="desktop-table-view">
        <div id="resultsList"></div>
      </div>

      <!-- æ‰‹æ©Ÿç‰ˆå¡ç‰‡é¡¯ç¤º -->
      <div id="mobileResults" class="mobile-card-view">
        <div id="mobileResultsList"></div>
      </div>
    </div>
  </div>

  <script>
    let allResults = []; // å„²å­˜æ‰€æœ‰æœå°‹çµæœ
    let filteredResults = []; // å„²å­˜ç¯©é¸å¾Œçš„çµæœ

    // ç›£è½çª—å£å¤§å°è®ŠåŒ–ï¼Œç¢ºä¿éŸ¿æ‡‰å¼åŠŸèƒ½æ­£å¸¸
    window.addEventListener('resize', () => {
      // å¦‚æœæœ‰æœå°‹çµæœï¼Œé‡æ–°é¡¯ç¤ºä»¥é©æ‡‰æ–°çš„è¢å¹•å¤§å°
      if (filteredResults.length > 0) {
        displayResults(filteredResults);
      }
    });

    const searchForm = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");
    let notificationPermissionRequest;

    function ensureNotificationPermission() {
      if (!("Notification" in window)) {
        return Promise.resolve(false);
      }
      if (Notification.permission === "granted") {
        return Promise.resolve(true);
      }
      if (Notification.permission === "denied") {
        return Promise.resolve(false);
      }
      if (!notificationPermissionRequest) {
        notificationPermissionRequest = Notification.requestPermission().then((result) => result === "granted");
      }
      return notificationPermissionRequest;
    }

    function showCtiNotification(payload) {
      ensureNotificationPermission().then((granted) => {
        if (!granted) {
          console.warn("CTI notification skipped - permission not granted");
          return;
        }
        const phone = payload.phone || "";
        const postal = payload.postalCode || "";
        const custId = payload.customerId || "";
        const lines = [
          phone ? `é›»è©±: ${phone}` : null,
          postal ? `éƒµéå€è™Ÿ: ${postal}` : null,
          custId ? `å®¢æˆ¶ID: ${custId}` : null,
        ].filter(Boolean);
        const body = lines.length > 0 ? lines.join("\n") : "æœ‰æ–°çš„ä¾†é›»é€šçŸ¥";
        try {
          const notification = new Notification("ä¾†é›»é€šçŸ¥", {
            body,
            tag: payload.confID || payload.key || "cti-pop",
            data: payload,
            renotify: true,
          });
          notification.onclick = () => {
            window.focus();
          };
        } catch (err) {
          console.warn("CTI notification failed", err);
        }
      });
    }

    ensureNotificationPermission();

    function toLocalPhone(phoneE164) {
      if (!phoneE164) return "";
      if (phoneE164.startsWith("+886")) {
        return "0" + phoneE164.slice(4);
      }
      return phoneE164;
    }

    async function performSearch(keyword) {
      if (!searchForm || !searchInput) {
        console.warn("search form elements missing");
        return;
      }

      const results = document.getElementById("results");
      const loading = document.getElementById("loading");
      const error = document.getElementById("error");
      const resultsList = document.getElementById("resultsList");

      if (!results || !loading || !error || !resultsList) {
        console.warn("search result containers missing");
        return;
      }

      results.classList.remove("hidden");
      loading.classList.remove("hidden");
      error.classList.add("hidden");
      resultsList.innerHTML = "";

      try {
        const res = await fetch(`/sales_info/search?keyword=${encodeURIComponent(keyword)}`);

        const contentType = res.headers.get('content-type') || '';
        if (res.redirected || (!contentType.includes('application/json') && !res.ok)) {
          window.location.href = res.url || '/login';
          return;
        }

        if (!contentType.includes('application/json')) {
          // fallback: treat as session expired or unexpected HTML
          window.location.href = '/login';
          return;
        }

        const data = await res.json();

        if (data.error) {
          error.textContent = data.error;
          error.classList.remove("hidden");
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          resultsList.innerHTML = "<div class=\"alert alert-info\">æ²’æœ‰ç¬¦åˆçµæœ</div>";
          return;
        }

        allResults = data;
        filteredResults = [...data];

        const resultSummary = document.getElementById("resultSummary");
        if (resultSummary) {
          resultSummary.classList.remove("hidden");
        }

        const mobileFilters = document.getElementById("mobileFilters");
        if (mobileFilters) {
          mobileFilters.classList.remove("hidden");
        }

        displayResults(filteredResults);
      } catch (err) {
        error.textContent = "ç³»çµ±éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦";
        error.classList.remove("hidden");
      } finally {
        loading.classList.add("hidden");
      }
    }

    if (searchForm) {
      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const keyword = searchInput.value.trim();
        if (!keyword) return;
        await performSearch(keyword);
      });
    }

    const initialParams = new URLSearchParams(window.location.search);
    const initialKeyword = (initialParams.get("phone") || initialParams.get("keyword") || "").trim();
    if (initialKeyword) {
      searchInput.value = initialKeyword;
      performSearch(initialKeyword);
    }

    (function initCtiSse() {
      try {
        const es = new EventSource("/sse/notifications");
        es.addEventListener("ping", function () { /* keepalive */ });
        es.onmessage = function (ev) {
          try {
            const msg = JSON.parse(ev.data || "{}");
            if (!msg || msg.type !== "CTI_POP") return;
            const displayPhone = msg.phone || "";
            const postal = msg.postalCode || "";
            const custId = msg.customerId || "";
            console.log("[CTI]", msg);
            showCtiNotification(msg);
            const autoKeyword = toLocalPhone(displayPhone) || displayPhone;
            if (autoKeyword) {
              searchInput.value = autoKeyword;
              performSearch(autoKeyword);
            }
          } catch (err) {
            console.warn("CTI parse fail", err);
          }
        };
        es.onerror = function () { /* expected on network errors */ };
      } catch (err) {
        console.warn("SSE init error", err);
      }
    })();
    // é¡¯ç¤ºçµæœçš„å‡½æ•¸
    function displayResults(data) {
      try {
        const resultsList = document.getElementById('resultsList');
        const resultCount = document.getElementById('resultCount');

        if (!resultsList) {
          console.error('æ‰¾ä¸åˆ° resultsList å…ƒç´ ');
          return;
        }

        if (data.length === 0) {
          resultsList.innerHTML = '<div class="alert alert-info">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</div>';
          const mobileResultsList = document.getElementById('mobileResultsList');
          if (mobileResultsList) {
            mobileResultsList.innerHTML = '<div class="alert alert-info">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</div>';
          }
          if (resultCount) resultCount.textContent = 'å…± 0 ç­†';
          return;
        }

        // æ’åºè³‡æ–™ (ç”±è¿‘åˆ°é ï¼Œå³æ—¥æœŸç”±æ–°åˆ°èˆŠ)
        data.sort((a, b) => {
          const parseDate = (rawDate) => {
            if (!rawDate) return new Date('1900-01-01');
            let dateStr = rawDate.toString().trim();
            dateStr = dateStr.replace(/\(.+?\)/g, '');

            // æ°‘åœ‹å¹´æ ¼å¼ (ä¾‹å¦‚: 113/12/25)
            if (/^\d{2,3}\/\d{1,2}\/\d{1,2}/.test(dateStr)) {
              const parts = dateStr.split('/');
              const year = parseInt(parts[0], 10) + 1911;
              const month = parts[1].padStart(2, '0');
              const day = parts[2].split(' ')[0].padStart(2, '0'); // è™•ç†å¯èƒ½åŒ…å«æ™‚é–“çš„æƒ…æ³
              return new Date(`${year}-${month}-${day}`);
            }

            // ä¸­æ–‡å¹´æœˆæ—¥æ ¼å¼ (ä¾‹å¦‚: 2024å¹´12æœˆ25æ—¥)
            if (/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/.test(dateStr)) {
              const year = dateStr.match(/(\d{4})å¹´/)[1];
              const month = dateStr.match(/å¹´(\d{1,2})æœˆ/)[1].padStart(2, '0');
              const day = dateStr.match(/æœˆ(\d{1,2})æ—¥/)[1].padStart(2, '0');
              return new Date(`${year}-${month}-${day}`);
            }

            // ISOæ ¼å¼æˆ–å…¶ä»–æ¨™æº–æ ¼å¼
            dateStr = dateStr.replace(/\//g, '-').split(' ')[0]; // åªå–æ—¥æœŸéƒ¨åˆ†
            const parsed = new Date(dateStr);
            return isNaN(parsed) ? new Date('1900-01-01') : parsed;
          };

          const dateA = parseDate(a.data.ç™¼è²¨æ—¥æœŸ || a.data.å–®æ“šæ—¥æœŸ || a.data.å‡ºå‹¤é–‹å§‹æ™‚é–“ || '');
          const dateB = parseDate(b.data.ç™¼è²¨æ—¥æœŸ || b.data.å–®æ“šæ—¥æœŸ || b.data.å‡ºå‹¤é–‹å§‹æ™‚é–“ || '');

          // ç”±è¿‘åˆ°é æ’åº (æ–°æ—¥æœŸåœ¨å‰)
          return dateB - dateA;
        });

        // å»ºç«‹è¡¨æ ¼
        const table = document.createElement('table');
        table.className = 'table table-bordered table-striped mt-3';

        // å…ˆå»ºç«‹è¡¨é ­
        const thead = document.createElement('thead');

        // æ¨™é¡Œè¡Œ
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
          <th style="width: 8%;">é¡å‹</th>
          <th style="width: 10%;">å–®æ“šç·¨è™Ÿ</th>
          <th style="width: 8%;">æ—¥æœŸ</th>
          <th style="width: 8%;">å®¢æˆ¶ä»£ç¢¼</th>
          <th style="width: 12%;">å®¢æˆ¶åç¨±</th>
          <th style="width: 10%;">æ¥­å‹™/ç¶­ä¿®äººå“¡</th>
          <th style="width: 10%;">è¯çµ¡é›»è©±</th>
          <th style="width: 18%;">åœ°å€</th>
          <th style="width: 16%;">å‚™è¨»/ç¶­ä¿®ç”¢å“</th>
          <th style="width: 8%;">æ“ä½œ</th>
        `;

        // ç¯©é¸è¡Œ
        const filterRow = document.createElement('tr');
        filterRow.className = 'bg-light';
        filterRow.innerHTML = `
          <td style="width: 8%;">
            <select id="typeFilter" class="form-select form-select-sm">
              <option value="">å…¨éƒ¨</option>
              <option value="customer">å®¢æˆ¶è³‡æ–™</option>
              <option value="sales">éŠ·å”®</option>
              <option value="repair">ç¶­ä¿®</option>
              <option value="custody">å¯„å€‰å‡ºè²¨</option>
            </select>
          </td>
          <td style="width: 10%;">
            <input type="text" id="docNoFilter" class="form-control form-control-sm" placeholder="å–®æ“šç·¨è™Ÿ" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸">
          </td>
          <td style="width: 8%;">
            <div style="display: flex; flex-direction: column; gap: 2px;">
              <input type="date" id="dateFromFilter" class="form-control form-control-sm" style="font-size: 9px; padding: 2px;" title="èµ·å§‹æ—¥æœŸ (è¨­å®šå®Œå…©å€‹æ—¥æœŸå¾Œè‡ªå‹•ç¯©é¸ï¼Œæˆ–æŒ‰ENTERç«‹å³ç¯©é¸)" placeholder="èµ·å§‹æ—¥æœŸ">
              <input type="date" id="dateToFilter" class="form-control form-control-sm" style="font-size: 9px; padding: 2px;" title="çµæŸæ—¥æœŸ (è¨­å®šå®Œå…©å€‹æ—¥æœŸå¾Œè‡ªå‹•ç¯©é¸ï¼Œæˆ–æŒ‰ENTERç«‹å³ç¯©é¸)" placeholder="çµæŸæ—¥æœŸ">
            </div>
          </td>
          <td style="width: 8%;">
            <input type="text" id="customerCodeFilter" class="form-control form-control-sm" placeholder="å®¢æˆ¶ä»£ç¢¼" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸">
          </td>
          <td style="width: 12%;">
            <input type="text" id="customerNameFilter" class="form-control form-control-sm" placeholder="å®¢æˆ¶åç¨±" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸">
          </td>
          <td style="width: 10%;">
            <input type="text" id="staffFilter" class="form-control form-control-sm" placeholder="æ¥­å‹™äººå“¡" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸">
          </td>
          <td style="width: 10%;">
            <input type="text" id="phoneFilter" class="form-control form-control-sm" placeholder="é›»è©±" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸">
          </td>
          <td style="width: 18%;">
            <input type="text" id="addressFilter" class="form-control form-control-sm" placeholder="åœ°å€é—œéµå­—" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸" style="width: 100%;">
          </td>
          <td style="width: 16%;">
            <input type="text" id="remarksFilter" class="form-control form-control-sm" placeholder="å‚™è¨»é—œéµå­—" title="è¼¸å…¥å¾ŒæŒ‰ENTERç¯©é¸" style="width: 100%;">
          </td>
          <td style="width: 8%;">
            <div style="display: flex; gap: 2px;">
              <button type="button" id="clearFilters" class="btn btn-outline-secondary btn-sm" title="æ¸…é™¤ç¯©é¸çµæœ(ä¿ç•™è¼¸å…¥æ¢ä»¶)" style="font-size: 10px;">
                <i class="bi bi-funnel"></i>
              </button>
              <button type="button" id="resetFilters" class="btn btn-outline-danger btn-sm" title="å®Œå…¨æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶" style="font-size: 10px;">
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
          </td>
        `;

        thead.appendChild(headerRow);
        thead.appendChild(filterRow);
        table.appendChild(thead);

        // å»ºç«‹è¡¨æ ¼ä¸»é«”
        const tbody = document.createElement('tbody');
        table.appendChild(tbody);

        // å¡«å…¥è³‡æ–™è¡Œ
        data.forEach(item => {
          const d = item.data;
          const row = document.createElement('tr');
          console.log('ğŸ” è™•ç†è³‡æ–™é …ç›®ï¼š', item.type, 'å–®æ“šç·¨è™Ÿï¼š', d.å–®æ“šç·¨è™Ÿ);
          if (item.type === 'customer') {
            row.innerHTML = `
            <td><span class="badge bg-info">å®¢æˆ¶è³‡æ–™</span></td>
            <td style="word-wrap: break-word;">-</td>
            <td style="word-wrap: break-word;">-</td>
            <td style="word-wrap: break-word;">
              ${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary text-decoration-underline">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}
            </td>
          <td style="word-wrap: break-word;">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.æ¥­å‹™äººå“¡åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.è¯çµ¡é›»è©± || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.è¯çµ¡åœ°å€ || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">è¯çµ¡äººï¼š${d.è¯çµ¡äºº || ''}</td>
            <td>
              ${d.å®¢æˆ¶ä»£ç¢¼ ? `<button class="btn btn-info btn-sm" onclick="showCustomerDetails('${d.å®¢æˆ¶ä»£ç¢¼}')"><i class='bi bi-person-lines-fill'></i> å®¢æˆ¶è©³æƒ…</button>` : ''}
            </td>
          `;
          } else if (item.type === 'custody') {
            row.innerHTML = `
            <td><span class="badge bg-warning text-dark">å¯„å€‰å‡ºè²¨</span></td>
            <td>${d.å–®æ“šç·¨è™Ÿ || ''}</td>
            <td>${d.å–®æ“šæ—¥æœŸ || ''}</td>
            <td>
              ${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary text-decoration-underline">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}
            </td>
          <td style="word-wrap: break-word;">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.æ¥­å‹™äººå“¡åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.è¯çµ¡é›»è©± || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.é€è²¨åœ°å€ || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.å‚™è¨» || ''}</td>
            <td>
              ${d.å–®æ“šç·¨è™Ÿ ? `<button class="btn btn-warning btn-sm" onclick="showCustodyDetails('${d.å–®æ“šç·¨è™Ÿ}')"><i class='bi bi-list-ul'></i> æŸ¥çœ‹æ˜ç´°</button>` : ''}
            </td>
          `;
          } else if (item.type === 'repair') {
            row.innerHTML = `
            <td><span class="badge bg-success">ç¶­ä¿®</span></td>
            <td>${d.å–®æ“šç·¨è™Ÿ || ''}</td>
            <td>${d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || d.ç™¼è²¨æ—¥æœŸ || ''}</td>
            <td>
              ${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary text-decoration-underline">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}
            </td>
          <td style="word-wrap: break-word;">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.ç¶­ä¿®äººå“¡ || d.æœå‹™äººå“¡ || ''}</td>
            <td style="word-wrap: break-word;">${d.è¯çµ¡é›»è©± || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.æœå‹™åœ°å€ || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.ç”¢å“åç¨± || ''}</td>
            <td>
              ${d.å–®æ“šç·¨è™Ÿ ? `<button class="btn btn-info btn-sm" onclick="showRepairDetails('${d.å–®æ“šç·¨è™Ÿ}')"><i class='bi bi-list-ul'></i> æŸ¥çœ‹æ˜ç´°</button>` : ''}
            </td>
          `;
          } else if (item.type === 'sales') {
            row.innerHTML = `
            <td><span class="badge bg-primary">éŠ·å”®</span></td>
            <td>${d.å–®æ“šç·¨è™Ÿ || ''}</td>
            <td>${d.å–®æ“šæ—¥æœŸ || d.ç™¼è²¨æ—¥æœŸ || ''}</td>
            <td>
              ${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary text-decoration-underline">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}
            </td>
          <td style="word-wrap: break-word;">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.æ¥­å‹™äººå“¡åç¨± || ''}</td>
            <td style="word-wrap: break-word;">${d.è¯çµ¡é›»è©± || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.é€è²¨åœ°å€ || ''}</td>
            <td style="word-wrap: break-word; white-space: normal;">${d.å‚™è¨» || ''}</td>
            <td>
              ${d.å–®æ“šç·¨è™Ÿ ? `<button class="btn btn-info btn-sm" onclick="showDetails('${d.å–®æ“šç·¨è™Ÿ}')"><i class='bi bi-list-ul'></i> æŸ¥çœ‹æ˜ç´°</button>` : ''}
            </td>
          `;
          } else {
            // æœªçŸ¥é¡å‹çš„é»˜èªè™•ç†
            console.warn('æœªçŸ¥çš„è³‡æ–™é¡å‹ï¼š', item.type);
            row.innerHTML = `
            <td><span class="badge bg-secondary">æœªçŸ¥</span></td>
            <td colspan="8">${JSON.stringify(d)}</td>
            <td></td>
          `;
          }
          tbody.appendChild(row);
        });

        // åŠ å…¥ä½¿ç”¨èªªæ˜
        const helpText = document.createElement('div');
        helpText.className = 'alert alert-info alert-sm mb-2';
        helpText.innerHTML = `
          <small>
            <i class="bi bi-info-circle me-1"></i>
            <strong>ç¯©é¸èªªæ˜ï¼š</strong>
            <strong>é¡å‹</strong>é¸æ“‡å¾Œç«‹å³ç¯©é¸ï¼›
            <strong>æ—¥æœŸ</strong>éœ€è¨­å®šå®Œèµ·è¨–å…©å€‹æ—¥æœŸå¾Œè‡ªå‹•ç¯©é¸ï¼ˆæˆ–æŒ‰<kbd>Enter</kbd>ç«‹å³ç¯©é¸ï¼‰ï¼›
            <strong>æ–‡å­—æ¬„ä½</strong>è¼¸å…¥å¾ŒæŒ‰ <kbd>Enter</kbd> éµç¯©é¸ã€‚
            <i class="bi bi-funnel"></i> æ¸…é™¤ç¯©é¸çµæœä½†ä¿ç•™æ¢ä»¶ï¼Œ
            <i class="bi bi-x-circle text-danger"></i> å®Œå…¨æ¸…é™¤æ‰€æœ‰æ¢ä»¶
          </small>
        `;

        resultsList.innerHTML = '';
        resultsList.appendChild(helpText);
        resultsList.appendChild(table);
        if (resultCount) resultCount.textContent = `å…± ${data.length} ç­†`;

        // ç¶å®šç¯©é¸äº‹ä»¶
        bindFilterEvents();

        // ç”Ÿæˆæ‰‹æ©Ÿç‰ˆå¡ç‰‡é¡¯ç¤º
        generateMobileCards(data);

        // é™¤éŒ¯ï¼šæª¢æŸ¥ç¯©é¸å™¨æ˜¯å¦æ­£ç¢ºå»ºç«‹
        console.log('ç¯©é¸å™¨æª¢æŸ¥:');
        const filterIds = ['typeFilter', 'docNoFilter', 'dateFromFilter', 'dateToFilter',
          'customerCodeFilter', 'customerNameFilter', 'staffFilter',
          'phoneFilter', 'addressFilter', 'remarksFilter'];
        filterIds.forEach(id => {
          const element = document.getElementById(id);
          console.log(`${id}:`, element ? 'âœ… å­˜åœ¨' : 'âŒ ä¸å­˜åœ¨');
          if (element && element.tagName === 'INPUT') {
            console.log(`  - å¯ç·¨è¼¯: ${!element.readOnly && !element.disabled}`);
          }
        });

      } catch (error) {
        console.error('displayResults éŒ¯èª¤:', error);
        const resultsList = document.getElementById('resultsList');
        if (resultsList) {
          resultsList.innerHTML = `<div class="alert alert-danger">é¡¯ç¤ºçµæœæ™‚ç™¼ç”ŸéŒ¯èª¤: ${error.message}</div>`;
        }
      }
    }

    // ç”Ÿæˆæ‰‹æ©Ÿç‰ˆå¡ç‰‡é¡¯ç¤º
    function generateMobileCards(data) {
      const mobileResultsList = document.getElementById('mobileResultsList');
      if (!mobileResultsList) return;

      if (data.length === 0) {
        mobileResultsList.innerHTML = '<div class="alert alert-info">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</div>';
        return;
      }

      mobileResultsList.innerHTML = '';

      data.forEach(item => {
        const d = item.data;
        const card = document.createElement('div');
        card.className = 'result-card';

        // æ ¹æ“šé¡å‹è¨­å®šä¸åŒçš„é¡¯ç¤ºå…§å®¹
        let typeInfo = '';
        let actionButton = '';
        let mainInfo = '';

        if (item.type === 'customer') {
          typeInfo = '<span class="card-type bg-info text-white">å®¢æˆ¶è³‡æ–™</span>';
          mainInfo = `
            <div class="card-row">
              <span class="card-label">å®¢æˆ¶ä»£ç¢¼:</span>
              <span class="card-value">${d.å®¢æˆ¶ä»£ç¢¼ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">å®¢æˆ¶åç¨±:</span>
              <span class="card-value">${d.å®¢æˆ¶åç¨± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">è¯çµ¡é›»è©±:</span>
              <span class="card-value">${d.è¯çµ¡é›»è©± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">åœ°å€:</span>
              <span class="card-value">${d.è¯çµ¡åœ°å€ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">è¯çµ¡äºº:</span>
              <span class="card-value">${d.è¯çµ¡äºº || ''}</span>
            </div>
          `;
          actionButton = d.å®¢æˆ¶ä»£ç¢¼ ? `<button class="btn btn-info btn-sm" onclick="showCustomerDetails('${d.å®¢æˆ¶ä»£ç¢¼}')"><i class='bi bi-person-lines-fill'></i> å®¢æˆ¶è©³æƒ…</button>` : '';
        } else if (item.type === 'sales') {
          typeInfo = '<span class="card-type bg-primary text-white">éŠ·å”®</span>';
          mainInfo = `
            <div class="card-row">
              <span class="card-label">æ—¥æœŸ:</span>
              <span class="card-value">${d.å–®æ“šæ—¥æœŸ || d.ç™¼è²¨æ—¥æœŸ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">å®¢æˆ¶:</span>
              <span class="card-value">${d.å®¢æˆ¶åç¨± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">æ¥­å‹™:</span>
              <span class="card-value">${d.æ¥­å‹™äººå“¡åç¨± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">é›»è©±:</span>
              <span class="card-value">${d.è¯çµ¡é›»è©± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">åœ°å€:</span>
              <span class="card-value">${d.é€è²¨åœ°å€ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">å‚™è¨»:</span>
              <span class="card-value">${d.å‚™è¨» || ''}</span>
            </div>
          `;
          actionButton = d.å–®æ“šç·¨è™Ÿ ? `<button class="btn btn-info btn-sm" onclick="showDetails('${d.å–®æ“šç·¨è™Ÿ}')"><i class='bi bi-list-ul'></i> æŸ¥çœ‹æ˜ç´°</button>` : '';
        } else if (item.type === 'repair') {
          typeInfo = '<span class="card-type bg-success text-white">ç¶­ä¿®</span>';
          mainInfo = `
            <div class="card-row">
              <span class="card-label">æ—¥æœŸ:</span>
              <span class="card-value">${d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || d.ç™¼è²¨æ—¥æœŸ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">å®¢æˆ¶:</span>
              <span class="card-value">${d.å®¢æˆ¶åç¨± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">ç¶­ä¿®äººå“¡:</span>
              <span class="card-value">${d.ç¶­ä¿®äººå“¡ || d.æœå‹™äººå“¡ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">é›»è©±:</span>
              <span class="card-value">${d.è¯çµ¡é›»è©± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">åœ°å€:</span>
              <span class="card-value">${d.æœå‹™åœ°å€ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">ç”¢å“:</span>
              <span class="card-value">${d.ç”¢å“åç¨± || ''}</span>
            </div>
          `;
          actionButton = d.å–®æ“šç·¨è™Ÿ ? `<button class="btn btn-info btn-sm" onclick="showRepairDetails('${d.å–®æ“šç·¨è™Ÿ}')"><i class='bi bi-list-ul'></i> æŸ¥çœ‹æ˜ç´°</button>` : '';
        } else if (item.type === 'custody') {
          typeInfo = '<span class="card-type bg-warning text-dark">å¯„å€‰å‡ºè²¨</span>';
          mainInfo = `
            <div class="card-row">
              <span class="card-label">æ—¥æœŸ:</span>
              <span class="card-value">${d.å–®æ“šæ—¥æœŸ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">å®¢æˆ¶:</span>
              <span class="card-value">${d.å®¢æˆ¶åç¨± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">æ¥­å‹™:</span>
              <span class="card-value">${d.æ¥­å‹™äººå“¡åç¨± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">é›»è©±:</span>
              <span class="card-value">${d.è¯çµ¡é›»è©± || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">åœ°å€:</span>
              <span class="card-value">${d.é€è²¨åœ°å€ || ''}</span>
            </div>
            <div class="card-row">
              <span class="card-label">å‚™è¨»:</span>
              <span class="card-value">${d.å‚™è¨» || ''}</span>
            </div>
          `;
          actionButton = d.å–®æ“šç·¨è™Ÿ ? `<button class="btn btn-warning btn-sm" onclick="showCustodyDetails('${d.å–®æ“šç·¨è™Ÿ}')"><i class='bi bi-list-ul'></i> æŸ¥çœ‹æ˜ç´°</button>` : '';
        }

        card.innerHTML = `
          <div class="card-header">
            ${typeInfo}
            <span class="card-doc-no">${d.å–®æ“šç·¨è™Ÿ || 'ç„¡å–®æ“šç·¨è™Ÿ'}</span>
          </div>
          <div class="card-body">
            ${mainInfo}
          </div>
          ${actionButton ? `<div class="card-actions">${actionButton}</div>` : ''}
        `;

        mobileResultsList.appendChild(card);
      });
    }

    // ç¯©é¸åŠŸèƒ½
    function applyFilters() {
      // å®‰å…¨åœ°ç²å–ç¯©é¸å™¨å€¼
      const typeFilter = document.getElementById('typeFilter')?.value || '';
      const docNoFilter = document.getElementById('docNoFilter')?.value.toLowerCase() || '';
      const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
      const dateToFilter = document.getElementById('dateToFilter')?.value || '';
      const customerCodeFilter = document.getElementById('customerCodeFilter')?.value.toLowerCase() || '';
      const customerNameFilter = document.getElementById('customerNameFilter')?.value.toLowerCase() || '';
      const staffFilter = document.getElementById('staffFilter')?.value.toLowerCase() || '';
      const phoneFilter = document.getElementById('phoneFilter')?.value.toLowerCase() || '';
      const addressFilter = document.getElementById('addressFilter')?.value.toLowerCase() || '';
      const remarksFilter = document.getElementById('remarksFilter')?.value.toLowerCase() || '';
      const filterStatus = document.getElementById('filterStatus');

      filteredResults = allResults.filter(item => {
        const d = item.data;

        // é¡å‹ç¯©é¸
        if (typeFilter && item.type !== typeFilter) {
          return false;
        }

        // å–®æ“šç·¨è™Ÿç¯©é¸
        if (docNoFilter) {
          const docNo = (d.å–®æ“šç·¨è™Ÿ || '').toLowerCase();
          if (!docNo.includes(docNoFilter)) return false;
        }

        // å®¢æˆ¶ä»£ç¢¼ç¯©é¸
        if (customerCodeFilter) {
          const customerCode = (d.å®¢æˆ¶ä»£ç¢¼ || '').toLowerCase();
          if (!customerCode.includes(customerCodeFilter)) return false;
        }

        // å®¢æˆ¶åç¨±ç¯©é¸
        if (customerNameFilter) {
          const customerName = (d.å®¢æˆ¶åç¨± || '').toLowerCase();
          if (!customerName.includes(customerNameFilter)) return false;
        }

        // æ¥­å‹™/ç¶­ä¿®äººå“¡ç¯©é¸
        if (staffFilter) {
          const staff = (d.æ¥­å‹™äººå“¡åç¨± || d.ç¶­ä¿®äººå“¡ || d.æœå‹™äººå“¡ || '').toLowerCase();
          if (!staff.includes(staffFilter)) return false;
        }

        // å‚™è¨»ç¯©é¸
        if (remarksFilter) {
          const remarks = (d.å‚™è¨» || d.ç”¢å“åç¨± || '').toLowerCase();
          if (!remarks.includes(remarksFilter)) return false;
        }

        // æ—¥æœŸç¯©é¸
        if (dateFromFilter || dateToFilter) {
          const itemDate = d.ç™¼è²¨æ—¥æœŸ || d.å–®æ“šæ—¥æœŸ || d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || '';
          if (itemDate) {
            // è§£ææ—¥æœŸ (èˆ‡æ’åºé‚è¼¯ä¿æŒä¸€è‡´)
            const parseDate = (rawDate) => {
              if (!rawDate) return null;
              let dateStr = rawDate.toString().trim();
              dateStr = dateStr.replace(/\(.+?\)/g, '');

              // æ°‘åœ‹å¹´æ ¼å¼
              if (/^\d{2,3}\/\d{1,2}\/\d{1,2}/.test(dateStr)) {
                const parts = dateStr.split('/');
                const year = parseInt(parts[0], 10) + 1911;
                const month = parts[1].padStart(2, '0');
                const day = parts[2].split(' ')[0].padStart(2, '0');
                return new Date(`${year}-${month}-${day}`);
              }

              // ä¸­æ–‡å¹´æœˆæ—¥æ ¼å¼
              if (/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/.test(dateStr)) {
                const year = dateStr.match(/(\d{4})å¹´/)[1];
                const month = dateStr.match(/å¹´(\d{1,2})æœˆ/)[1].padStart(2, '0');
                const day = dateStr.match(/æœˆ(\d{1,2})æ—¥/)[1].padStart(2, '0');
                return new Date(`${year}-${month}-${day}`);
              }

              // ISOæ ¼å¼æˆ–å…¶ä»–æ¨™æº–æ ¼å¼
              dateStr = dateStr.replace(/\//g, '-').split(' ')[0];
              const parsed = new Date(dateStr);
              return isNaN(parsed) ? null : parsed;
            };

            const itemDateObj = parseDate(itemDate);
            if (itemDateObj) {
              if (dateFromFilter) {
                const fromDate = new Date(dateFromFilter);
                if (itemDateObj < fromDate) return false;
              }
              if (dateToFilter) {
                const toDate = new Date(dateToFilter);
                if (itemDateObj > toDate) return false;
              }
            }
          }
        }

        // é›»è©±ç¯©é¸
        if (phoneFilter) {
          const phone = (d.è¯çµ¡é›»è©± || '').toLowerCase();
          if (!phone.includes(phoneFilter)) return false;
        }

        // åœ°å€ç¯©é¸
        if (addressFilter) {
          const address = (d.è¯çµ¡åœ°å€ || d.é€è²¨åœ°å€ || d.æœå‹™åœ°å€ || '').toLowerCase();
          if (!address.includes(addressFilter)) return false;
        }

        return true;
      });

      // æ›´æ–°ç¯©é¸ç‹€æ…‹é¡¯ç¤º
      const activeFilters = [];
      if (typeFilter) activeFilters.push(`é¡å‹:${typeFilter}`);
      if (docNoFilter) activeFilters.push(`å–®æ“š:${docNoFilter}`);
      if (dateFromFilter) activeFilters.push(`èµ·å§‹:${dateFromFilter}`);
      if (dateToFilter) activeFilters.push(`çµæŸ:${dateToFilter}`);
      if (customerCodeFilter) activeFilters.push(`ä»£ç¢¼:${customerCodeFilter}`);
      if (customerNameFilter) activeFilters.push(`å®¢æˆ¶:${customerNameFilter}`);
      if (staffFilter) activeFilters.push(`äººå“¡:${staffFilter}`);
      if (phoneFilter) activeFilters.push(`é›»è©±:${phoneFilter}`);
      if (addressFilter) activeFilters.push(`åœ°å€:${addressFilter}`);
      if (remarksFilter) activeFilters.push(`å‚™è¨»:${remarksFilter}`);

      if (activeFilters.length > 0) {
        filterStatus.textContent = `å·²å¥—ç”¨ç¯©é¸: ${activeFilters.join(', ')}`;
      } else {
        filterStatus.textContent = 'é¡¯ç¤ºå…¨éƒ¨çµæœ';
      }

      displayResults(filteredResults);
    }

    // æ¸…é™¤ç¯©é¸ (åªæ¸…é™¤ç¯©é¸çµæœï¼Œä¿ç•™è¼¸å…¥å…§å®¹)
    function clearFilters() {
      // é‡ç½®ç¯©é¸çµæœç‚ºå…¨éƒ¨è³‡æ–™ï¼Œä½†ä¿ç•™ä½¿ç”¨è€…è¼¸å…¥çš„ç¯©é¸æ¢ä»¶
      filteredResults = [...allResults];

      const filterStatus = document.getElementById('filterStatus');
      if (filterStatus) {
        filterStatus.textContent = 'å·²æ¸…é™¤ç¯©é¸ (ä¿ç•™è¼¸å…¥æ¢ä»¶)';
      }

      displayResults(filteredResults);
    }

    // å®Œå…¨æ¸…é™¤æ‰€æœ‰ç¯©é¸æ¢ä»¶å’Œçµæœ
    function resetAllFilters() {
      const filters = [
        'typeFilter', 'docNoFilter', 'dateFromFilter', 'dateToFilter',
        'customerCodeFilter', 'customerNameFilter', 'staffFilter',
        'phoneFilter', 'addressFilter', 'remarksFilter'
      ];

      const mobileFilters = [
        'mobileTypeFilter', 'mobileCustomerNameFilter', 'mobileDateFromFilter', 'mobileDateToFilter'
      ];

      // æ¸…é™¤æ¡Œé¢ç‰ˆç¯©é¸å™¨
      filters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
          element.value = '';
        }
      });

      // æ¸…é™¤æ‰‹æ©Ÿç‰ˆç¯©é¸å™¨
      mobileFilters.forEach(filterId => {
        const element = document.getElementById(filterId);
        if (element) {
          element.value = '';
        }
      });

      filteredResults = [...allResults];

      const filterStatus = document.getElementById('filterStatus');
      if (filterStatus) {
        filterStatus.textContent = 'é¡¯ç¤ºå…¨éƒ¨çµæœ';
      }

      displayResults(filteredResults);
    }

    // ç¶å®šç¯©é¸äº‹ä»¶ (å»¶é²ç¶å®šï¼Œç­‰è¡¨æ ¼å»ºç«‹å¾Œ)
    function bindFilterEvents() {
      console.log('ğŸ”— é–‹å§‹ç¶å®šç¯©é¸äº‹ä»¶');

      const typeFilter = document.getElementById('typeFilter');
      const docNoFilter = document.getElementById('docNoFilter');
      const dateFromFilter = document.getElementById('dateFromFilter');
      const dateToFilter = document.getElementById('dateToFilter');
      const customerCodeFilter = document.getElementById('customerCodeFilter');
      const customerNameFilter = document.getElementById('customerNameFilter');
      const staffFilter = document.getElementById('staffFilter');
      const phoneFilter = document.getElementById('phoneFilter');
      const addressFilter = document.getElementById('addressFilter');
      const remarksFilter = document.getElementById('remarksFilter');
      const clearFiltersBtn = document.getElementById('clearFilters');

      // é¡å‹ä¸‹æ‹‰é¸å–®ç«‹å³ç¯©é¸
      if (typeFilter) {
        typeFilter.addEventListener('change', applyFilters);
        console.log('âœ… typeFilter äº‹ä»¶å·²ç¶å®š');
      }

      // æ—¥æœŸé¸æ“‡å™¨ï¼šåªæœ‰åœ¨å…©å€‹æ—¥æœŸéƒ½æœ‰å€¼æ™‚æ‰è‡ªå‹•ç¯©é¸ï¼Œæˆ–è€…æŒ‰ ENTER éµç¯©é¸
      if (dateFromFilter) {
        dateFromFilter.addEventListener('change', () => {
          const dateFrom = dateFromFilter.value;
          const dateTo = dateToFilter ? dateToFilter.value : '';
          console.log(`èµ·å§‹æ—¥æœŸè®Šæ›´: ${dateFrom}, çµæŸæ—¥æœŸ: ${dateTo}`);

          // åªæœ‰ç•¶å…©å€‹æ—¥æœŸéƒ½æœ‰å€¼æ™‚æ‰è‡ªå‹•ç¯©é¸
          if (dateFrom && dateTo) {
            console.log('å…©å€‹æ—¥æœŸéƒ½å·²è¨­å®šï¼Œé–‹å§‹ç¯©é¸');
            applyFilters();
          } else {
            console.log('ç­‰å¾…è¨­å®šå®Œæ•´çš„æ—¥æœŸç¯„åœ');
          }
        });

        dateFromFilter.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            console.log('èµ·å§‹æ—¥æœŸæŒ‰ä¸‹ ENTERï¼Œé–‹å§‹ç¯©é¸');
            applyFilters();
          }
        });

        console.log('âœ… dateFromFilter äº‹ä»¶å·²ç¶å®š');
      }

      if (dateToFilter) {
        dateToFilter.addEventListener('change', () => {
          const dateFrom = dateFromFilter ? dateFromFilter.value : '';
          const dateTo = dateToFilter.value;
          console.log(`çµæŸæ—¥æœŸè®Šæ›´: ${dateTo}, èµ·å§‹æ—¥æœŸ: ${dateFrom}`);

          // åªæœ‰ç•¶å…©å€‹æ—¥æœŸéƒ½æœ‰å€¼æ™‚æ‰è‡ªå‹•ç¯©é¸
          if (dateFrom && dateTo) {
            console.log('å…©å€‹æ—¥æœŸéƒ½å·²è¨­å®šï¼Œé–‹å§‹ç¯©é¸');
            applyFilters();
          } else {
            console.log('ç­‰å¾…è¨­å®šå®Œæ•´çš„æ—¥æœŸç¯„åœ');
          }
        });

        dateToFilter.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            console.log('çµæŸæ—¥æœŸæŒ‰ä¸‹ ENTERï¼Œé–‹å§‹ç¯©é¸');
            applyFilters();
          }
        });

        console.log('âœ… dateToFilter äº‹ä»¶å·²ç¶å®š');
      }

      // æ–‡å­—è¼¸å…¥æ¡†ï¼šæŒ‰ ENTER éµæ‰ç¯©é¸
      const textFilters = [
        { element: docNoFilter, name: 'docNoFilter' },
        { element: customerCodeFilter, name: 'customerCodeFilter' },
        { element: customerNameFilter, name: 'customerNameFilter' },
        { element: staffFilter, name: 'staffFilter' },
        { element: phoneFilter, name: 'phoneFilter' },
        { element: addressFilter, name: 'addressFilter' },
        { element: remarksFilter, name: 'remarksFilter' }
      ];

      textFilters.forEach(filter => {
        if (filter.element) {
          // æ¸¬è©¦è¼¸å…¥åŠŸèƒ½
          filter.element.addEventListener('focus', () => {
            console.log(`${filter.name} ç²å¾—ç„¦é»`);
          });

          filter.element.addEventListener('input', (e) => {
            console.log(`${filter.name} è¼¸å…¥: "${e.target.value}"`);
          });

          // æŒ‰ ENTER éµæ‰ç¯©é¸
          filter.element.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
              console.log(`${filter.name} æŒ‰ä¸‹ ENTERï¼Œé–‹å§‹ç¯©é¸`);
              applyFilters();
            }
          });

          console.log(`âœ… ${filter.name} äº‹ä»¶å·²ç¶å®š`);
        } else {
          console.log(`âŒ ${filter.name} å…ƒç´ ä¸å­˜åœ¨`);
        }
      });

      // æ¸…é™¤æŒ‰éˆ•
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', clearFilters);
        console.log('âœ… clearFilters äº‹ä»¶å·²ç¶å®š');
      }

      // é‡ç½®æŒ‰éˆ•
      const resetFiltersBtn = document.getElementById('resetFilters');
      if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', resetAllFilters);
        console.log('âœ… resetFilters äº‹ä»¶å·²ç¶å®š');
      }

      // ç¶å®šæ‰‹æ©Ÿç‰ˆç¯©é¸å™¨äº‹ä»¶
      const mobileTypeFilter = document.getElementById('mobileTypeFilter');
      const mobileCustomerNameFilter = document.getElementById('mobileCustomerNameFilter');
      const mobileDateFromFilter = document.getElementById('mobileDateFromFilter');
      const mobileDateToFilter = document.getElementById('mobileDateToFilter');
      const mobileClearFilters = document.getElementById('mobileClearFilters');
      const mobileResetFilters = document.getElementById('mobileResetFilters');

      if (mobileTypeFilter) {
        mobileTypeFilter.addEventListener('change', () => {
          // åŒæ­¥åˆ°æ¡Œé¢ç‰ˆç¯©é¸å™¨
          if (typeFilter) typeFilter.value = mobileTypeFilter.value;
          applyFilters();
        });
      }

      if (mobileCustomerNameFilter) {
        mobileCustomerNameFilter.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            // åŒæ­¥åˆ°æ¡Œé¢ç‰ˆç¯©é¸å™¨
            if (customerNameFilter) customerNameFilter.value = mobileCustomerNameFilter.value;
            applyFilters();
          }
        });
      }

      if (mobileDateFromFilter) {
        mobileDateFromFilter.addEventListener('change', () => {
          // åŒæ­¥åˆ°æ¡Œé¢ç‰ˆç¯©é¸å™¨
          if (dateFromFilter) dateFromFilter.value = mobileDateFromFilter.value;
          const dateFrom = mobileDateFromFilter.value;
          const dateTo = mobileDateToFilter ? mobileDateToFilter.value : '';
          if (dateFrom && dateTo) {
            applyFilters();
          }
        });
      }

      if (mobileDateToFilter) {
        mobileDateToFilter.addEventListener('change', () => {
          // åŒæ­¥åˆ°æ¡Œé¢ç‰ˆç¯©é¸å™¨
          if (dateToFilter) dateToFilter.value = mobileDateToFilter.value;
          const dateFrom = mobileDateFromFilter ? mobileDateFromFilter.value : '';
          const dateTo = mobileDateToFilter.value;
          if (dateFrom && dateTo) {
            applyFilters();
          }
        });
      }

      if (mobileClearFilters) {
        mobileClearFilters.addEventListener('click', clearFilters);
      }

      if (mobileResetFilters) {
        mobileResetFilters.addEventListener('click', resetAllFilters);
      }

      console.log('âœ… æ‰€æœ‰ç¯©é¸äº‹ä»¶ç¶å®šå®Œæˆ');
    }

    // å°‡å„ç¨®æ ¼å¼çš„æ•¸å­—å­—ä¸²è½‰æˆæ•¸å€¼ï¼šç§»é™¤åƒåˆ†ä½èˆ‡éæ•¸å­—ç¬¦è™Ÿ
    function toNumber(val) {
      if (typeof val === 'number') return val;
      if (val == null) return 0;
      const s = String(val)
        .replace(/\s+/g, '')              // å»ç©ºç™½
        .replace(/[\uFF10-\uFF19]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFF10 + 0x30)) // å…¨å½¢æ•¸å­—è½‰åŠå½¢
        .replace(/[ï¼Œ,]/g, '')             // å»åƒåˆ†ä½
        .replace(/[^0-9+\-\.]/g, '');    // ç§»é™¤éæ•¸å­—ç¬¦è™Ÿ
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    async function showDetails(docNo) {
      console.log('ğŸ” showDetails å‡½æ•¸è¢«èª¿ç”¨ï¼Œå–®æ“šç·¨è™Ÿï¼š', docNo);
      try {
        const res = await fetch(`/sales_info/sales_details/${docNo}`);
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        if (!data.success || !data.details) {
          alert('ç„¡æ³•ç²å–éŠ·å”®æ˜ç´°è³‡æ–™');
          return;
        }

        const total = data.details.reduce((sum, d) => sum + (parseFloat(d.å«ç¨…é‡‘é¡) || 0), 0);
        const container = document.createElement('div');
        container.className = 'detail-container';
        container.innerHTML = `
          <h5><i class="bi bi-bag-check me-2"></i>éŠ·å”®æ˜ç´°</h5>
          <table class="table">
            <thead><tr><th>ç”¢å“åç¨±</th><th>æ•¸é‡</th><th>å–®åƒ¹</th><th>å«ç¨…é‡‘é¡</th></tr></thead>
            <tbody>
              ${data.details.length > 0 ? data.details.map(d => `
                <tr>
                  <td>${d.ç”¢å“åç¨± || ''}</td>
                  <td>${d.äº¤æ˜“æ•¸é‡ || ''}</td>
                  <td>${d.äº¤æ˜“åƒ¹ || ''}</td>
                  <td>${d.å«ç¨…é‡‘é¡ || ''}</td>
                </tr>
              `).join('') : '<tr><td colspan="4" class="text-center">æ²’æœ‰æ˜ç´°è³‡æ–™</td></tr>'}
              ${data.details.length > 0 ? `<tr class="total-row"><td colspan="3" class="text-end">ç¸½è¨ˆ</td><td>${total.toLocaleString()}</td></tr>` : ''}
            </tbody>
          </table>
        `;

        // å‰ç«¯ä¿éšªå†è¨ˆç®—ä¸€æ¬¡åˆè¨ˆï¼ˆè™•ç†åƒåˆ†ä½æˆ–éæ•¸å­—ç¬¦è™Ÿå°è‡´ parseFloat å¤±çœŸï¼‰
        try {
          const tbodyRows = Array.from(container.querySelectorAll('tbody tr'));
          const totalRow = tbodyRows.find(tr => tr.classList.contains('total-row'));
          const dataRows = tbodyRows.filter(tr => !tr.classList.contains('total-row'));
          let fixedTotal = 0;
          dataRows.forEach(tr => {
            const tds = tr.querySelectorAll('td');
            if (tds && tds.length >= 4) {
              fixedTotal += toNumber(tds[3].textContent || '');
            }
          });
          if (totalRow) {
            const cells = totalRow.querySelectorAll('td');
            if (cells && cells.length > 0) {
              cells[cells.length - 1].textContent = fixedTotal.toLocaleString();
            }
          }
        } catch (e) {
          console.warn('Recalculate total failed:', e);
        }

        insertAfterRow(docNo, container, 'showDetails');
      } catch (error) {
        console.error('ç²å–éŠ·å”®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        alert('ç²å–éŠ·å”®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    async function showRepairDetails(docNo) {
      const res = await fetch(`/sales_info/repair_details/${docNo}`);
      const data = await res.json();
      if (data.error) return alert(data.error);

      const container = document.createElement('div');
      container.className = 'detail-container';
      container.innerHTML = `
        <h5><i class="bi bi-tools me-2"></i>ç¶­ä¿®ç´€éŒ„</h5>
        <p><strong>å•é¡Œæè¿°ï¼š</strong><br>${data["å•é¡Œæè¿°"] || 'ç„¡'}</p>
        <p><strong>å ±ä¿®åŸå› ï¼š</strong><br>${data["å ±ä¿®åŸå› "] || 'ç„¡'}</p>
        <p><strong>è™•ç†çµæœï¼š</strong><br>${data["å ±ä¿®è™•ç†çµæœ"] || 'ç„¡'}</p>
        <p><strong>å®Œå·¥æƒ…æ³ï¼š</strong><br><span class="multiline-finish">${data["å®Œå·¥æƒ…æ³"] || 'ç„¡'}</span></p>
        <p><strong>å‚™è¨»ï¼š</strong><br>${data["å‚™è¨»"] || 'ç„¡'}</p>
      `;
      insertAfterRow(docNo, container, 'showRepairDetails');
    }

    async function showCustodyDetails(docNo) {
      const res = await fetch(`/sales_info/custody_details/${docNo}`);
      const data = await res.json();
      if (data.error) return alert(data.error);
      const container = document.createElement('div');
      container.className = 'detail-container';
      container.innerHTML = `
        <h5><i class="bi bi-box-seam me-2"></i>å¯„å€‰å‡ºè²¨æ˜ç´°</h5>
        <table class="table">
          <thead><tr><th>ç”¢å“åç¨±</th><th>æ•¸é‡</th></tr></thead>
          <tbody>
            ${data.details.map(d => `
              <tr>
                <td>${d.ç”¢å“åç¨± || ''}</td>
                <td>${d.äº¤æ˜“æ•¸é‡ || ''}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;
      insertAfterRow(docNo, container, 'showCustodyDetails');
    }

    async function showCustomerDetails(customerCode) {
      const res = await fetch(`/sales_info/customer_details/${customerCode}`);
      const data = await res.json();
      if (data.error) return alert(data.error);

      const basic = data.basic_info;
      const container = document.createElement('div');
      container.className = 'detail-container';
      container.innerHTML = `
        <h5><i class="bi bi-person-lines-fill me-2"></i>å®¢æˆ¶è©³ç´°è³‡æ–™</h5>
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">åŸºæœ¬è³‡è¨Š</h6>
            <table class="table table-sm">
              <tr><td><strong>å®¢æˆ¶ä»£ç¢¼ï¼š</strong></td><td>${basic.å®¢æˆ¶ä»£ç¢¼ || ''}</td></tr>
              <tr><td><strong>å®¢æˆ¶åç¨±ï¼š</strong></td><td>${basic.å®¢æˆ¶åç¨± || ''}</td></tr>
              <tr><td><strong>è¯çµ¡åœ°å€ï¼š</strong></td><td>${basic.è¯çµ¡åœ°å€ || ''}</td></tr>
              <tr><td><strong>éƒµéå€è™Ÿï¼š</strong></td><td>${basic.éƒµéå€è™Ÿ || ''}</td></tr>
              <tr><td><strong>è¯çµ¡é›»è©±ï¼š</strong></td><td>${basic.è¯çµ¡é›»è©± || ''}</td></tr>
              <tr><td><strong>è¯çµ¡äººï¼š</strong></td><td>${basic.è¯çµ¡äºº || ''}</td></tr>
              <tr><td><strong>æ¥­å‹™äººå“¡ï¼š</strong></td><td>${basic.æ¥­å‹™äººå“¡åç¨± || ''}</td></tr>
              <tr><td><strong>éŠ·å”®åˆ†é¡ï¼š</strong></td><td>${basic.éŠ·å”®åˆ†é¡ç¢¼åç¨± || ''}</td></tr>
              <tr><td><strong>éŠ·å”®é€šè·¯ï¼š</strong></td><td>${basic.é è¨­éŠ·å”®é€šè·¯åç¨± || ''}</td></tr>
            </table>
          </div>
          <div class="col-md-6">
            ${data.addresses && data.addresses.length > 0 ? `
              <h6 class="text-success">é€è²¨åœ°å€</h6>
              <div class="mb-3">
                ${data.addresses.map(addr => `
                  <div class="border p-2 mb-2 rounded">
                    <small class="text-muted">åœ°å€è³‡è¨Š</small><br>
                    ${Object.values(addr).filter(v => v && v.trim()).join(' | ')}
                  </div>
                `).join('')}
              </div>
            ` : ''}
            ${data.contacts && data.contacts.length > 0 ? `
              <h6 class="text-warning">æ¥­å‹™è¯çµ¡äºº</h6>
              <div>
                ${data.contacts.map(contact => `
                  <div class="border p-2 mb-2 rounded">
                    <small class="text-muted">è¯çµ¡äººè³‡è¨Š</small><br>
                    ${Object.values(contact).filter(v => v && v.trim()).join(' | ')}
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        </div>
      `;
      insertAfterRow(customerCode, container, 'showCustomerDetails');
    }

    function insertAfterRow(docNo, element, funcName) {
      // æª¢æŸ¥æ˜¯å¦ç‚ºæ‰‹æ©Ÿç‰ˆé¡¯ç¤º
      const isMobile = window.innerWidth <= 768;

      if (isMobile) {
        // æ‰‹æ©Ÿç‰ˆï¼šåœ¨å¡ç‰‡ä¸­æ’å…¥æ˜ç´°
        insertInMobileCard(docNo, element, funcName);
      } else {
        // æ¡Œé¢ç‰ˆï¼šåœ¨è¡¨æ ¼ä¸­æ’å…¥æ˜ç´°
        const row = document.querySelector(`tr:has(button[onclick="${funcName}('${docNo}')"])`);
        if (!row) return;

        const nextRow = row.nextElementSibling;
        if (nextRow && nextRow.classList.contains('detail-row')) {
          nextRow.remove();
        } else {
          const detailRow = document.createElement('tr');
          detailRow.className = 'detail-row';
          const cell = document.createElement('td');
          cell.colSpan = 100;
          cell.appendChild(element);
          detailRow.appendChild(cell);
          row.parentNode.insertBefore(detailRow, row.nextSibling);
        }
      }
    }

    // æ‰‹æ©Ÿç‰ˆå¡ç‰‡æ˜ç´°æ’å…¥å‡½æ•¸
    function insertInMobileCard(docNo, element, funcName) {
      // æ‰¾åˆ°å°æ‡‰çš„å¡ç‰‡
      const cards = document.querySelectorAll('.result-card');
      let targetCard = null;

      cards.forEach(card => {
        const button = card.querySelector(`button[onclick="${funcName}('${docNo}')"]`);
        if (button) {
          targetCard = card;
        }
      });

      if (!targetCard) return;

      // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰æ˜ç´°é¡¯ç¤º
      const existingDetail = targetCard.querySelector('.mobile-detail-container');
      if (existingDetail) {
        existingDetail.remove();
        return;
      }

      // å‰µå»ºæ‰‹æ©Ÿç‰ˆæ˜ç´°å®¹å™¨
      const mobileDetailContainer = document.createElement('div');
      mobileDetailContainer.className = 'mobile-detail-container';
      mobileDetailContainer.style.cssText = `
        margin-top: 1rem;
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 6px;
        border-left: 4px solid #007bff;
      `;

      // èª¿æ•´æ˜ç´°å…§å®¹çš„æ¨£å¼ä»¥é©åˆæ‰‹æ©Ÿ
      element.style.cssText = `
        margin: 0;
        font-size: 0.9rem;
      `;

      // å¦‚æœæ˜ç´°åŒ…å«è¡¨æ ¼ï¼Œèª¿æ•´è¡¨æ ¼æ¨£å¼
      const tables = element.querySelectorAll('table');
      tables.forEach(table => {
        table.style.cssText = `
          font-size: 0.8rem;
          margin-bottom: 0;
        `;
        table.className = 'table table-sm table-bordered';
      });

      mobileDetailContainer.appendChild(element);
      targetCard.appendChild(mobileDetailContainer);
    }

    // é¡¯ç¤ºæœå‹™ç™»è¨˜å¡è³‡æ–™
    async function showServiceCard(customerCode) {
      if (!customerCode) {
        alert('å®¢æˆ¶ç·¨è™Ÿä¸èƒ½ç‚ºç©º');
        return;
      }

      try {
        const res = await fetch(`/sales_info/service_card/${customerCode}`);
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        // é–‹å•Ÿæ–°è¦–çª—é¡¯ç¤ºæœå‹™ç™»è¨˜å¡è³‡æ–™
        const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
        newWindow.document.write(generateServiceCardHTML(data, customerCode));
        newWindow.document.close();

      } catch (error) {
        console.error('æŸ¥è©¢æœå‹™ç™»è¨˜å¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        alert('æŸ¥è©¢æœå‹™ç™»è¨˜å¡æ™‚ç™¼ç”ŸéŒ¯èª¤');
      }
    }

    // ç”Ÿæˆæœå‹™ç™»è¨˜å¡HTMLå…§å®¹
    function generateServiceCardHTML(data, customerCode) {
      let html = `
        <!DOCTYPE html>
        <html lang="zh-TW">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>æœå‹™ç™»è¨˜å¡ - ${customerCode}</title>
          <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
          <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
          <style>
            body { font-family: 'Microsoft JhengHei', sans-serif; }
            .service-card-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
            .main-info { background-color: #f8f9fa; border-left: 4px solid #007bff; }
            .detail-section { margin-top: 20px; }
            .table th { background-color: #e9ecef; }
          </style>
        </head>
        <body>
          <div class="container-fluid py-4">
            <div class="service-card-header p-4 rounded mb-4">
              <h2><i class="bi bi-card-checklist me-2"></i>æœå‹™ç™»è¨˜å¡ - ${customerCode}</h2>
            </div>
      `;

      if (data.length === 0) {
        html += `
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>æ‰¾ä¸åˆ°å®¢æˆ¶ç·¨è™Ÿ ${customerCode} çš„æœå‹™ç™»è¨˜å¡è³‡æ–™
            </div>
          </div>
        </body>
        </html>
        `;
        return html;
      }

      // æŒ‰æœå‹™ç™»è¨˜è™Ÿåˆ†çµ„é¡¯ç¤º
      data.forEach(service => {
        html += `
          <div class="card mb-4">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-file-text me-2"></i>æœå‹™ç™»è¨˜è™Ÿï¼š${service.main.æœå‹™ç™»è¨˜è™Ÿ}</h5>
            </div>
            <div class="card-body">
              <div class="main-info p-3 rounded mb-3">
                <h6 class="text-primary mb-3"><i class="bi bi-info-circle me-2"></i>ä¸»æª”è³‡æ–™</h6>
                <div class="row">
                  <div class="col-md-6">
                    <table class="table table-sm table-borderless">
                      <tr><td><strong>æœå‹™ç™»è¨˜è™Ÿï¼š</strong></td><td>${service.main.æœå‹™ç™»è¨˜è™Ÿ || ''}</td></tr>
                      <tr><td><strong>å®¢æˆ¶ï¼š</strong></td><td>${service.main.å®¢æˆ¶ || ''}</td></tr>
                      <tr><td><strong>å®¢æˆ¶åç¨±ï¼š</strong></td><td>${service.main.å®¢æˆ¶åç¨± || ''}</td></tr>
                      <tr><td><strong>ç”¢å“ï¼š</strong></td><td>${service.main.ç”¢å“ || ''}</td></tr>
                      <tr><td><strong>ç”¢å“åç¨±ï¼š</strong></td><td>${service.main.ç”¢å“åç¨± || ''}</td></tr>
                      <tr><td><strong>è³¼è²·æ—¥æœŸï¼š</strong></td><td>${service.main.è³¼è²·æ—¥æœŸ || ''}</td></tr>
                    </table>
                  </div>
                  <div class="col-md-6">
                    <table class="table table-sm table-borderless">
                      <tr><td><strong>è¯çµ¡äººï¼š</strong></td><td>${service.main.è¯çµ¡äºº || ''}</td></tr>
                      <tr><td><strong>è¯çµ¡é›»è©±ï¼š</strong></td><td>${service.main.è¯çµ¡é›»è©± || ''}</td></tr>
                      <tr><td><strong>åœ°å€ï¼š</strong></td><td>${service.main.åœ°å€ || ''}</td></tr>
                      <tr><td><strong>è¡Œå‹•é›»è©±ï¼š</strong></td><td>${service.main.è¡Œå‹•é›»è©± || ''}</td></tr>
                      <tr><td><strong>ä¿å›ºæœŸé™ï¼š</strong></td><td>${service.main.ä¿å›ºæœŸé™ || ''}</td></tr>
                      <tr><td><strong>è£æ©Ÿä½ç½®èªªæ˜ï¼š</strong></td><td>${service.main.è£æ©Ÿä½ç½®èªªæ˜ || ''}</td></tr>
                    </table>
                  </div>
                </div>
              </div>
        `;

        if (service.details && service.details.length > 0) {
          html += `
              <div class="detail-section">
                <h6 class="text-success mb-3"><i class="bi bi-list-ul me-2"></i>æ˜ç´°è³‡æ–™</h6>
                <div class="table-responsive">
                  <table class="table table-striped table-hover">
                    <thead>
                      <tr>
                        <th>ç‰©æ–™ä»£ç¢¼</th>
                        <th>ç”¢å“åç¨±</th>
                        <th>æ¨™æº–å”®åƒ¹</th>
                        <th>æ›´æ›æœŸé™(æœˆ)</th>
                        <th>ä¸Šæ¬¡æ›´æ›</th>
                        <th>ä¸Šæ¬¡é€šçŸ¥</th>
                        <th>ä¸‹æ¬¡é€šçŸ¥</th>
                        <th>æ•¸é‡</th>
                      </tr>
                    </thead>
                    <tbody>
          `;

          service.details.forEach(detail => {
            html += `
                      <tr>
                        <td>${detail.ç‰©æ–™ä»£ç¢¼ || ''}</td>
                        <td>${detail.ç”¢å“åç¨± || ''}</td>
                        <td>${detail.æ¨™æº–å”®åƒ¹ ? detail.æ¨™æº–å”®åƒ¹.toLocaleString() : ''}</td>
                        <td>${detail.æ›´æ›æœŸé™_æœˆ || ''}</td>
                        <td>${detail.ä¸Šæ¬¡æ›´æ› || ''}</td>
                        <td>${detail.ä¸Šæ¬¡é€šçŸ¥ || ''}</td>
                        <td>${detail.ä¸‹æ¬¡é€šçŸ¥ || ''}</td>
                        <td>${detail.æ•¸é‡ || ''}</td>
                      </tr>
            `;
          });

          html += `
                    </tbody>
                  </table>
                </div>
              </div>
          `;
        } else {
          html += `
              <div class="alert alert-info">
                <i class="bi bi-info-circle me-2"></i>æ­¤æœå‹™ç™»è¨˜è™Ÿæ²’æœ‰æ˜ç´°è³‡æ–™
              </div>
          `;
        }

        html += `
            </div>
          </div>
        `;
      });

      html += `
          </div>
        </body>
        </html>
      `;

      return html;
    }

    // ç¢ºèªå‡½æ•¸æ˜¯å¦æ­£ç¢ºåŠ è¼‰
    console.log('âœ… showDetails å‡½æ•¸å·²å®šç¾©ï¼š', typeof showDetails === 'function');
    console.log('âœ… showRepairDetails å‡½æ•¸å·²å®šç¾©ï¼š', typeof showRepairDetails === 'function');
    console.log('âœ… showCustodyDetails å‡½æ•¸å·²å®šç¾©ï¼š', typeof showCustodyDetails === 'function');
    console.log('âœ… showCustomerDetails å‡½æ•¸å·²å®šç¾©ï¼š', typeof showCustomerDetails === 'function');
    console.log('âœ… showServiceCard å‡½æ•¸å·²å®šç¾©ï¼š', typeof showServiceCard === 'function');
  </script>
</body>

</html>









