<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>å‡ºè²¨ç¶­ä¿®è³‡æ–™æŸ¥è©¢ç³»çµ± v2.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- FontAwesome v6.4.0 -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-color: #f4f6f9;
      --navbar-bg: #ffffff;
      --card-bg: #ffffff;
      --text-dark: #2c3e50;
      --text-muted: #7f8c8d;
      --color-business: #3498db;
      --color-assistant: #1abc9c;
      --color-sales: #9b59b6;
      --color-crm: #f39c12;
      --color-inventory: #27ae60;
      --color-share: #7f8c8d;
      --color-procure: #e74c3c;
      --border-color: #e9ecef;
      --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-dark);
      font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
    }

    /* Navbar Style */
    .navbar {
      background-color: var(--navbar-bg);
      height: 70px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .navbar-brand {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text-dark);
    }

    .navbar-brand img {
      height: 45px;
      width: auto;
      object-fit: contain;
    }

    .navbar-user {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-welcome {
      font-weight: 500;
      color: var(--text-muted);
    }

    .logout-btn {
      background-color: #e74c3c;
      color: white;
      text-decoration: none;
      padding: 8px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: var(--transition);
    }

    .logout-btn:hover {
      background-color: #c0392b;
      box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
      transform: translateY(-1px);
    }

    /* Search Form Style */
    .search-form {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
      margin: 2rem auto;
      max-width: 900px;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .search-input {
      padding: 0.8rem 1.2rem;
      font-size: 1.05rem;
      border-radius: 8px 0 0 8px !important;
      border: 1px solid #ddd;
    }

    .search-input:focus {
      box-shadow: none;
      border-color: var(--color-business);
    }

    .search-btn {
      background-color: var(--color-business);
      color: white;
      padding: 0 1.5rem;
      border-radius: 0 8px 8px 0 !important;
      font-weight: 600;
      transition: var(--transition);
    }

    .search-btn:hover {
      background-color: #2980b9;
      color: white;
      box-shadow: 0 4px 8px rgba(52, 152, 219, 0.3);
    }

    /* Result Containers */
    .result-container,
    .detail-container {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.03);
      padding: 1.5rem;
      margin-top: 2rem;
      border: 1px solid rgba(0, 0, 0, 0.05);
    }

    /* Table Styles */
    .table thead th {
      background-color: #f8f9fa;
      color: var(--text-dark);
      font-weight: 700;
      border-bottom: 2px solid #eee;
      padding: 12px 8px;
    }

    .table tbody tr {
      transition: var(--transition);
    }

    .table tbody tr:hover {
      background-color: rgba(52, 152, 219, 0.02) !important;
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .table td {
      vertical-align: top;
      padding: 12px 8px;
      border-bottom: 1px solid #f0f0f0;
    }

    .total-row {
      background-color: var(--text-dark) !important;
      color: white;
      font-weight: bold;
    }

    .hidden {
      display: none !important;
    }

    /* Badge Overrides */
    .badge {
      padding: 0.5em 0.8em;
      font-weight: 600;
      border-radius: 6px;
    }

    .bg-primary {
      background-color: var(--color-sales) !important;
    }

    .bg-info {
      background-color: var(--color-business) !important;
    }

    .bg-success {
      background-color: var(--color-inventory) !important;
    }

    .bg-warning {
      background-color: var(--color-crm) !important;
    }

    /* Mobile Responsive Card Style */
    @media (max-width: 768px) {
      .navbar {
        padding: 0 15px;
      }

      .navbar-brand span {
        display: none;
      }

      .search-form {
        padding: 1.2rem;
        margin: 1rem auto;
      }

      .mobile-card-view {
        display: block !important;
      }

      .desktop-table-view {
        display: none !important;
      }

      .result-card {
        background: var(--card-bg);
        border: 1px solid rgba(0, 0, 0, 0.05);
        border-radius: 12px;
        margin-bottom: 1.2rem;
        padding: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.02);
        position: relative;
        overflow: hidden;
      }

      /* ç”¨å·¦é‚Šæ¡†é¡è‰²å€åˆ†é¡å‹ */
      .result-card::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 5px;
        background-color: var(--type-color, #ddd);
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.8rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #f0f0f0;
      }

      .card-type {
        font-size: 0.8rem;
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-weight: bold;
        color: white;
      }

      .card-row {
        display: flex;
        margin-bottom: 0.6rem;
      }

      .card-label {
        font-weight: 700;
        color: var(--text-muted);
        min-width: 80px;
        font-size: 0.9rem;
      }

      .card-value {
        color: var(--text-dark);
        font-size: 0.9rem;
        flex: 1;
      }

      .card-actions {
        margin-top: 1rem;
        padding-top: 0.8rem;
        border-top: 1px solid #f0f0f0;
        display: flex;
        justify-content: flex-end;
      }

      .card-actions .btn {
        border-radius: 8px;
        font-weight: 600;
      }
    }

    @media (min-width: 769px) {
      .mobile-card-view {
        display: none !important;
      }

      .desktop-table-view {
        display: block !important;
      }
    }
  </style>
</head>

<body>
  <nav class="navbar">
    <a href="/" class="navbar-brand">
      <img src="{{ url_for('custom_static_images', filename='logo.png') }}" alt="ä¸–ç£Šå¯¦æ¥­">
    </a>
    <div class="navbar-user">
      <span class="user-welcome">æ‚¨å¥½ï¼Œ{{ session['name'] if session['name'] else session['username'] }}</span>
      <a href="{{ url_for('logout') }}" class="logout-btn">
        <i class="fa-solid fa-right-from-bracket me-1"></i> ç™»å‡º
      </a>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="search-form">
      <form id="searchForm">
        <div class="input-group">
          <input type="text" id="searchInput" class="form-control search-input"
            placeholder="è«‹è¼¸å…¥é—œéµå­—ï¼ˆå®¢æˆ¶åç¨±ã€åœ°å€ã€é›»è©±ã€å®¢æˆ¶ä»£ç¢¼ã€è¯çµ¡äººï¼‰" required />
          <button type="submit" class="btn search-btn">
            <i class="bi bi-search me-2"></i>æœå°‹
          </button>
        </div>
      </form>
    </div>

    <div id="results" class="result-container hidden">
      <div id="loading" class="text-center py-5 hidden">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
        </div>
      </div>
      <div id="error" class="alert alert-danger hidden"></div>

      <!-- çµæœçµ±è¨ˆ -->
      <div id="resultSummary" class="mb-3 hidden">
        <div class="d-flex justify-content-between align-items-center">
          <span class="badge bg-light text-dark border" id="filterStatus">é¡¯ç¤ºå…¨éƒ¨çµæœ</span>
          <span class="text-muted fw-bold" id="resultCount">å…± 0 ç­†</span>
        </div>
      </div>

      <!-- æ‰‹æ©Ÿç‰ˆç¯©é¸å™¨ -->
      <div id="mobileFilters"
        class="mobile-filters d-block d-md-none hidden mb-3 p-3 bg-white rounded-3 shadow-sm border">
        <div class="row g-2">
          <div class="col-6">
            <label class="form-label small fw-bold">é¡å‹</label>
            <select id="mobileTypeFilter" class="form-select form-select-sm">
              <option value="">å…¨éƒ¨</option>
              <option value="customer">å®¢æˆ¶è³‡æ–™</option>
              <option value="sales">éŠ·å”®</option>
              <option value="repair">ç¶­ä¿®</option>
              <option value="custody">å¯„å€‰å‡ºè²¨</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label small fw-bold">å®¢æˆ¶åç¨±</label>
            <input type="text" id="mobileCustomerNameFilter" class="form-select form-select-sm" placeholder="æœå°‹åç¨±">
          </div>
          <div class="col-6">
            <label class="form-label small fw-bold">èµ·å§‹æ—¥æœŸ</label>
            <input type="date" id="mobileDateFromFilter" class="form-control form-control-sm">
          </div>
          <div class="col-6">
            <label class="form-label small fw-bold">çµæŸæ—¥æœŸ</label>
            <input type="date" id="mobileDateToFilter" class="form-control form-control-sm">
          </div>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button type="button" id="mobileClearFilters"
            class="btn btn-sm btn-outline-secondary flex-grow-1">æ¸…é™¤ç¯©é¸</button>
          <button type="button" id="mobileResetFilters" class="btn btn-sm btn-outline-danger flex-grow-1">é‡ç½®</button>
        </div>
      </div>

      <!-- æ¡Œé¢ç‰ˆè¡¨æ ¼é¡¯ç¤º -->
      <div id="desktopResults" class="desktop-table-view">
        <div id="resultsList"></div>
      </div>

      <!-- æ‰‹æ©Ÿç‰ˆå¡ç‰‡é¡¯ç¤º -->
      <div id="mobileResults" class="mobile-card-view">
        <div id="mobileResultsList"></div>
      </div>

      <div class="text-center mt-4">
        <button id="loadMoreBtn" type="button" class="btn btn-primary px-4 py-2 hidden">
          <i class="bi bi-arrow-down-circle me-2"></i>è¼‰å…¥æ›´å¤šè³‡æ–™
        </button>
      </div>
    </div>
  </div>

  <script>
    let allResults = []; // å„²å­˜æ‰€æœ‰æœå°‹çµæœ
    let filteredResults = []; // å„²å­˜ç¯©é¸å¾Œçš„çµæœ

    // ç›£è½çª—å£å¤§å°è®ŠåŒ–ï¼Œç¢ºä¿éŸ¿æ‡‰å¼åŠŸèƒ½æ­£å¸¸
    window.addEventListener('resize', () => {
      // å¦‚æœæœ‰æœå°‹çµæœï¼Œé‡æ–°é¡¯ç¤ºä»¥é©æ‡‰æ–°çš„è¢å¹•å¤§å°
      if (filteredResults.length > 0) {
        displayResults(filteredResults);
      }
    });

    const LIMIT_STEP = 50;
    let currentLimit = LIMIT_STEP;
    let currentKeyword = '';
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    const searchForm = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");
    let notificationPermissionRequest;

    function updateLoadMoreButton(currentLength) {
      if (!loadMoreBtn) return;
      if (!currentKeyword || currentLength < currentLimit) {
        loadMoreBtn.classList.add('hidden');
      } else {
        loadMoreBtn.classList.remove('hidden');
      }
      loadMoreBtn.disabled = false;
      loadMoreBtn.textContent = 'è¼‰å…¥æ›´å¤šè³‡æ–™';
    }

    async function fetchAndRenderResults({ isLoadMore = false } = {}) {
      const results = document.getElementById('results');
      const loading = document.getElementById('loading');
      const error = document.getElementById('error');
      const resultsList = document.getElementById('resultsList');
      const mobileResultsList = document.getElementById('mobileResultsList');
      const resultSummary = document.getElementById('resultSummary');
      const mobileFilters = document.getElementById('mobileFilters');

      if (!currentKeyword) return;
      if (!results || !loading || !error || !resultsList) return;

      error.classList.add('hidden');
      error.textContent = '';

      if (!isLoadMore) {
        results.classList.remove('hidden');
        loading.classList.remove('hidden');
        resultsList.innerHTML = '';
        if (mobileResultsList) mobileResultsList.innerHTML = '';
        if (resultSummary) resultSummary.classList.add('hidden');
        if (mobileFilters) mobileFilters.classList.add('hidden');
      } else if (loadMoreBtn) {
        loadMoreBtn.disabled = true;
        loadMoreBtn.textContent = 'è¼‰å…¥ä¸­...';
      }

      try {
        const params = new URLSearchParams({
          keyword: currentKeyword,
          limit: currentLimit.toString()
        });
        const res = await fetch(`/sales_info/search?${params.toString()}`);

        const contentType = res.headers.get('content-type') || '';
        if (res.redirected || (!contentType.includes('application/json') && !res.ok)) {
          window.location.href = res.url || '/login';
          return;
        }
        if (!contentType.includes('application/json')) {
          window.location.href = '/login';
          return;
        }

        const data = await res.json();
        if (data.error) {
          error.textContent = data.error;
          error.classList.remove('hidden');
          updateLoadMoreButton(0);
          return;
        }
        if (!Array.isArray(data)) {
          error.textContent = 'ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
          error.classList.remove('hidden');
          updateLoadMoreButton(0);
          return;
        }

        if (data.length === 0) {
          if (!isLoadMore) {
            allResults = [];
            filteredResults = [];
            const emptyHtml = '<div class="alert alert-info">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</div>';
            resultsList.innerHTML = emptyHtml;
            if (mobileResultsList) mobileResultsList.innerHTML = emptyHtml;
            if (resultSummary) resultSummary.classList.add('hidden');
            if (mobileFilters) mobileFilters.classList.add('hidden');
          }
          updateLoadMoreButton(0);
          return;
        }

        allResults = data;
        filteredResults = [...data];

        if (resultSummary) resultSummary.classList.remove('hidden');
        if (mobileFilters) mobileFilters.classList.remove('hidden');

        if (typeof applyFilters === 'function') {
          applyFilters();
        } else {
          displayResults(filteredResults);
        }

        updateLoadMoreButton(data.length);
      } catch (err) {
        error.textContent = 'ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦';
        error.classList.remove('hidden');
        updateLoadMoreButton(0);
      } finally {
        if (!isLoadMore) {
          loading.classList.add('hidden');
        }
        if (loadMoreBtn) {
          loadMoreBtn.disabled = false;
          if (!loadMoreBtn.classList.contains('hidden')) {
            loadMoreBtn.textContent = 'è¼‰å…¥æ›´å¤šè³‡æ–™';
          }
        }
      }
    }

    function startSearch(keyword) {
      currentKeyword = keyword;
      currentLimit = LIMIT_STEP;
      if (loadMoreBtn) {
        loadMoreBtn.classList.add('hidden');
        loadMoreBtn.disabled = false;
        loadMoreBtn.textContent = 'è¼‰å…¥æ›´å¤šè³‡æ–™';
      }
      fetchAndRenderResults({ isLoadMore: false });
    }

    function ensureNotificationPermission() {
      if (!("Notification" in window)) {
        return Promise.resolve(false);
      }
      if (Notification.permission === "granted") {
        return Promise.resolve(true);
      }
      if (Notification.permission === "denied") {
        return Promise.resolve(false);
      }
      if (!notificationPermissionRequest) {
        notificationPermissionRequest = Notification.requestPermission().then((result) => result === "granted");
      }
      return notificationPermissionRequest;
    }

    function showCtiNotification(payload) {
      ensureNotificationPermission().then((granted) => {
        if (!granted) {
          console.warn("CTI notification skipped - permission not granted");
          return;
        }
        const phone = payload.phone || "";
        const postal = payload.postalCode || "";
        const custId = payload.customerId || "";
        const lines = [
          phone ? `é›»è©±: ${phone}` : null,
          postal ? `éƒµéå€è™Ÿ: ${postal}` : null,
          custId ? `å®¢æˆ¶ID: ${custId}` : null,
        ].filter(Boolean);
        const body = lines.length > 0 ? lines.join("\n") : "æœ‰æ–°çš„ä¾†é›»é€šçŸ¥";
        try {
          const notification = new Notification("ä¾†é›»é€šçŸ¥", {
            body,
            tag: payload.confID || payload.key || "cti-pop",
            data: payload,
            renotify: true,
          });
          notification.onclick = () => {
            window.focus();
          };
        } catch (err) {
          console.warn("CTI notification failed", err);
        }
      });
    }

    ensureNotificationPermission();

    function toLocalPhone(phoneE164) {
      if (!phoneE164) return "";
      if (phoneE164.startsWith("+886")) {
        return "0" + phoneE164.slice(4);
      }
      if (phoneE164.startsWith("+")) {
        return phoneE164.slice(1);
      }
      return phoneE164;
    }

    if (searchForm) {
      searchForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const keyword = searchInput.value.trim();
        if (!keyword) return;
        startSearch(keyword);
      });
    }

    const initialParams = new URLSearchParams(window.location.search);
    const initialKeywordRaw = (initialParams.get("phone") || initialParams.get("keyword") || "").trim();
    if (initialKeywordRaw) {
      const initialKeyword = toLocalPhone(initialKeywordRaw) || initialKeywordRaw;
      searchInput.value = initialKeyword;
      startSearch(initialKeyword);
    }

    (function initCtiSse() {
      try {
        const es = new EventSource("/sse/notifications");
        es.addEventListener("ping", function () { /* keepalive */ });
        es.onmessage = function (ev) {
          try {
            const msg = JSON.parse(ev.data || "{}");
            if (!msg || msg.type !== "CTI_POP") return;
            const displayPhone = msg.phone || "";
            console.log("[CTI]", msg);
            showCtiNotification(msg);
            const autoKeyword = toLocalPhone(displayPhone) || displayPhone;
            if (autoKeyword) {
              searchInput.value = autoKeyword;
              startSearch(autoKeyword);
            }
          } catch (err) {
            console.warn("CTI parse fail", err);
          }
        };
        es.onerror = function () { /* expected on network errors */ };
      } catch (err) {
        console.warn("SSE init error", err);
      }
    })();

    if (loadMoreBtn) {
      loadMoreBtn.addEventListener('click', async () => {
        if (!currentKeyword || loadMoreBtn.disabled) return;
        currentLimit += LIMIT_STEP;
        await fetchAndRenderResults({ isLoadMore: true });
      });
    }

    function displayResults(data) {
      try {
        const resultsList = document.getElementById('resultsList');
        const resultCount = document.getElementById('resultCount');

        if (!resultsList) return;

        if (data.length === 0) {
          const emptyHtml = '<div class="alert alert-info">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</div>';
          resultsList.innerHTML = emptyHtml;
          const mobileResultsList = document.getElementById('mobileResultsList');
          if (mobileResultsList) mobileResultsList.innerHTML = emptyHtml;
          if (resultCount) resultCount.textContent = 'å…± 0 ç­†';
          return;
        }

        data.sort((a, b) => {
          const parseDate = (rawDate) => {
            if (!rawDate) return new Date('1900-01-01');
            let dateStr = rawDate.toString().trim().replace(/\(.+?\)/g, '');
            if (/^\d{2,3}\/\d{1,2}\/\d{1,2}/.test(dateStr)) {
              const parts = dateStr.split('/');
              const year = parseInt(parts[0], 10) + 1911;
              return new Date(`${year}-${parts[1].padStart(2, '0')}-${parts[2].split(' ')[0].padStart(2, '0')}`);
            }
            if (/\d{4}å¹´\d{1,2}æœˆ\d{1,2}æ—¥/.test(dateStr)) {
              const year = dateStr.match(/(\d{4})å¹´/)[1];
              const month = dateStr.match(/å¹´(\d{1,2})æœˆ/)[1].padStart(2, '0');
              const day = dateStr.match(/æœˆ(\d{1,2})æ—¥/)[1].padStart(2, '0');
              return new Date(`${year}-${month}-${day}`);
            }
            dateStr = dateStr.replace(/\//g, '-').split(' ')[0];
            const parsed = new Date(dateStr);
            return isNaN(parsed) ? new Date('1900-01-01') : parsed;
          };
          const dateA = parseDate(a.data.ç™¼è²¨æ—¥æœŸ || a.data.å–®æ“šæ—¥æœŸ || a.data.å‡ºå‹¤é–‹å§‹æ™‚é–“ || '');
          const dateB = parseDate(b.data.ç™¼è²¨æ—¥æœŸ || b.data.å–®æ“šæ—¥æœŸ || b.data.å‡ºå‹¤é–‹å§‹æ™‚é–“ || '');
          return dateB - dateA;
        });

        const table = document.createElement('table');
        table.className = 'table table-hover mt-3';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.innerHTML = `
          <th style="width: 100px;">é¡å‹</th>
          <th style="width: 120px;">å–®æ“šç·¨è™Ÿ</th>
          <th style="width: 110px;">æ—¥æœŸ</th>
          <th style="width: 100px;">å®¢æˆ¶ä»£ç¢¼</th>
          <th>å®¢æˆ¶åç¨±</th>
          <th style="width: 120px;">æ¥­å‹™äººå“¡</th>
          <th style="width: 120px;">è¯çµ¡é›»è©±</th>
          <th style="width: 20%;">åœ°å€</th>
          <th style="width: 15%;">å‚™è¨»/ç”¢å“</th>
          <th style="width: 100px;">æ“ä½œ</th>
        `;

        const filterRow = document.createElement('tr');
        filterRow.className = 'bg-light';
        filterRow.innerHTML = `
          <td>
            <select id="typeFilter" class="form-select form-select-sm">
              <option value="">å…¨éƒ¨</option>
              <option value="customer">å®¢æˆ¶è³‡æ–™</option>
              <option value="sales">éŠ·å”®</option>
              <option value="repair">ç¶­ä¿®</option>
              <option value="custody">å¯„å€‰å‡ºè²¨</option>
            </select>
          </td>
          <td><input type="text" id="docNoFilter" class="form-control form-control-sm" placeholder="ç·¨è™Ÿ"></td>
          <td>
            <div class="d-flex flex-column gap-1">
              <input type="date" id="dateFromFilter" class="form-control form-control-sm" style="font-size: 10px;">
              <input type="date" id="dateToFilter" class="form-control form-control-sm" style="font-size: 10px;">
            </div>
          </td>
          <td><input type="text" id="customerCodeFilter" class="form-control form-control-sm" placeholder="ä»£ç¢¼"></td>
          <td><input type="text" id="customerNameFilter" class="form-control form-control-sm" placeholder="åç¨±"></td>
          <td><input type="text" id="staffFilter" class="form-control form-control-sm" placeholder="äººå“¡"></td>
          <td><input type="text" id="phoneFilter" class="form-control form-control-sm" placeholder="é›»è©±"></td>
          <td><input type="text" id="addressFilter" class="form-control form-control-sm" placeholder="é—œéµå­—"></td>
          <td><input type="text" id="remarksFilter" class="form-control form-control-sm" placeholder="é—œéµå­—"></td>
          <td>
            <div class="d-flex gap-1">
              <button id="clearFilters" class="btn btn-outline-secondary btn-sm" title="æ¸…é™¤ç¯©é¸"><i class="bi bi-funnel"></i></button>
              <button id="resetFilters" class="btn btn-outline-danger btn-sm" title="é‡ç½®"><i class="bi bi-x-circle"></i></button>
            </div>
          </td>
        `;

        thead.appendChild(headerRow);
        thead.appendChild(filterRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        data.forEach(item => {
          const d = item.data;
          const row = document.createElement('tr');
          if (item.type === 'customer') {
            row.innerHTML = `
            <td><span class="badge bg-info">å®¢æˆ¶è³‡æ–™</span></td>
            <td>-</td><td>-</td>
            <td>${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary fw-bold">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}</td>
            <td class="fw-bold">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td>${d.æ¥­å‹™äººå“¡åç¨± || ''}</td>
            <td>${d.è¯çµ¡é›»è©± || ''}</td>
            <td class="small">${d.è¯çµ¡åœ°å€ || ''}</td>
            <td class="small">è¯çµ¡äººï¼š${d.è¯çµ¡äºº || ''}</td>
            <td><button class="btn btn-outline-primary btn-sm" onclick="showCustomerDetails('${d.å®¢æˆ¶ä»£ç¢¼}')">è©³æƒ…</button></td>
          `;
          } else if (item.type === 'custody') {
            row.innerHTML = `
            <td><span class="badge bg-warning text-dark">å¯„å€‰å‡ºè²¨</span></td>
            <td>${d.å–®æ“šç·¨è™Ÿ || ''}</td><td>${d.å–®æ“šæ—¥æœŸ || ''}</td>
            <td>${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary fw-bold">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}</td>
            <td class="fw-bold">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td>${d.æ¥­å‹™äººå“¡åç¨± || ''}</td>
            <td>${d.è¯çµ¡é›»è©± || ''}</td>
            <td class="small">${d.é€è²¨åœ°å€ || ''}</td>
            <td class="small">${d.å‚™è¨» || ''}</td>
            <td><button class="btn btn-outline-warning btn-sm" onclick="showCustodyDetails('${d.å–®æ“šç·¨è™Ÿ}')">æ˜ç´°</button></td>
          `;
          } else if (item.type === 'repair') {
            row.innerHTML = `
            <td><span class="badge bg-success">ç¶­ä¿®</span></td>
            <td>${d.å–®æ“šç·¨è™Ÿ || ''}</td><td>${d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || d.ç™¼è²¨æ—¥æœŸ || ''}</td>
            <td>${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary fw-bold">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}</td>
            <td class="fw-bold">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td>${d.ç¶­ä¿®äººå“¡ || d.æœå‹™äººå“¡ || ''}</td>
            <td>${d.è¯çµ¡é›»è©± || ''}</td>
            <td class="small">${d.æœå‹™åœ°å€ || ''}</td>
            <td class="small">${d.ç”¢å“åç¨± || ''}</td>
            <td><button class="btn btn-outline-success btn-sm" onclick="showRepairDetails('${d.å–®æ“šç·¨è™Ÿ}')">æ˜ç´°</button></td>
          `;
          } else if (item.type === 'sales') {
            row.innerHTML = `
            <td><span class="badge bg-primary">éŠ·å”®</span></td>
            <td>${d.å–®æ“šç·¨è™Ÿ || ''}</td><td>${d.å–®æ“šæ—¥æœŸ || d.ç™¼è²¨æ—¥æœŸ || ''}</td>
            <td>${d.å®¢æˆ¶ä»£ç¢¼ ? `<a href="javascript:void(0)" onclick="showServiceCard('${d.å®¢æˆ¶ä»£ç¢¼}')" class="text-primary fw-bold">${d.å®¢æˆ¶ä»£ç¢¼}</a>` : ''}</td>
            <td class="fw-bold">${d.å®¢æˆ¶åç¨± || ''}</td>
            <td>${d.æ¥­å‹™äººå“¡åç¨± || ''}</td>
            <td>${d.è¯çµ¡é›»è©± || ''}</td>
            <td class="small">${d.é€è²¨åœ°å€ || ''}</td>
            <td class="small">${d.å‚™è¨» || ''}</td>
            <td><button class="btn btn-outline-primary btn-sm" onclick="showDetails('${d.å–®æ“šç·¨è™Ÿ}')">æ˜ç´°</button></td>
          `;
          }
          tbody.appendChild(row);
        });
        table.appendChild(tbody);

        resultsList.innerHTML = '';
        resultsList.appendChild(table);
        if (resultCount) resultCount.textContent = `å…± ${data.length} ç­†`;

        bindFilterEvents();
        generateMobileCards(data);

      } catch (error) {
        console.error('displayResults éŒ¯èª¤:', error);
      }
    }

    function generateMobileCards(data) {
      const mobileResultsList = document.getElementById('mobileResultsList');
      if (!mobileResultsList) return;
      mobileResultsList.innerHTML = '';

      data.forEach(item => {
        const d = item.data;
        const card = document.createElement('div');
        card.className = 'result-card';

        let typeColor = '#3498db';
        let typeName = 'éŠ·å”®';
        if (item.type === 'repair') { typeColor = '#27ae60'; typeName = 'ç¶­ä¿®'; }
        if (item.type === 'customer') { typeColor = '#3498db'; typeName = 'å®¢æˆ¶è³‡æ–™'; }
        if (item.type === 'custody') { typeColor = '#f39c12'; typeName = 'å¯„å€‰å‡ºè²¨'; }

        card.style.setProperty('--type-color', typeColor);

        let actionButton = '';
        let infoHtml = '';

        if (item.type === 'customer') {
          infoHtml = `
            <div class="card-row"><span class="card-label">ä»£ç¢¼:</span><span class="card-value">${d.å®¢æˆ¶ä»£ç¢¼ || ''}</span></div>
            <div class="card-row"><span class="card-label">åç¨±:</span><span class="card-value fw-bold">${d.å®¢æˆ¶åç¨± || ''}</span></div>
            <div class="card-row"><span class="card-label">é›»è©±:</span><span class="card-value">${d.è¯çµ¡é›»è©± || ''}</span></div>
            <div class="card-row"><span class="card-label">åœ°å€:</span><span class="card-value small">${d.è¯çµ¡åœ°å€ || ''}</span></div>
          `;
          actionButton = `<button class="btn btn-sm btn-primary" onclick="showCustomerDetails('${d.å®¢æˆ¶ä»£ç¢¼}')">æŸ¥çœ‹è©³æƒ…</button>`;
        } else {
          infoHtml = `
            <div class="card-row"><span class="card-label">æ—¥æœŸ:</span><span class="card-value">${d.å–®æ“šæ—¥æœŸ || d.ç™¼è²¨æ—¥æœŸ || d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || ''}</span></div>
            <div class="card-row"><span class="card-label">å®¢æˆ¶:</span><span class="card-value fw-bold">${d.å®¢æˆ¶åç¨± || ''}</span></div>
            <div class="card-row"><span class="card-label">é›»è©±:</span><span class="card-value">${d.è¯çµ¡é›»è©± || ''}</span></div>
          `;
          const func = item.type === 'repair' ? 'showRepairDetails' : (item.type === 'custody' ? 'showCustodyDetails' : 'showDetails');
          const btnClass = item.type === 'custody' ? 'btn-warning' : (item.type === 'repair' ? 'btn-success' : 'btn-primary');
          actionButton = `<button class="btn btn-sm ${btnClass}" onclick="${func}('${d.å–®æ“šç·¨è™Ÿ}')">æŸ¥çœ‹æ˜ç´°</button>`;
        }

        card.innerHTML = `
          <div class="card-header">
            <span class="card-type" style="background-color: ${typeColor}">${typeName}</span>
            <span class="card-doc-no">${d.å–®æ“šç·¨è™Ÿ || ''}</span>
          </div>
          <div class="card-body">${infoHtml}</div>
          <div class="card-actions">${actionButton}</div>
        `;
        mobileResultsList.appendChild(card);
      });
    }

    function applyFilters() {
      const typeFilter = document.getElementById('typeFilter')?.value || '';
      const docNoFilter = document.getElementById('docNoFilter')?.value.toLowerCase() || '';
      const dateFromFilter = document.getElementById('dateFromFilter')?.value || '';
      const dateToFilter = document.getElementById('dateToFilter')?.value || '';
      const customerCodeFilter = document.getElementById('customerCodeFilter')?.value.toLowerCase() || '';
      const customerNameFilter = document.getElementById('customerNameFilter')?.value.toLowerCase() || '';
      const staffFilter = document.getElementById('staffFilter')?.value.toLowerCase() || '';
      const phoneFilter = document.getElementById('phoneFilter')?.value.toLowerCase() || '';
      const addressFilter = document.getElementById('addressFilter')?.value.toLowerCase() || '';
      const remarksFilter = document.getElementById('remarksFilter')?.value.toLowerCase() || '';

      filteredResults = allResults.filter(item => {
        const d = item.data;
        if (typeFilter && item.type !== typeFilter) return false;
        if (docNoFilter && !(d.å–®æ“šç·¨è™Ÿ || '').toLowerCase().includes(docNoFilter)) return false;
        if (customerCodeFilter && !(d.å®¢æˆ¶ä»£ç¢¼ || '').toLowerCase().includes(customerCodeFilter)) return false;
        if (customerNameFilter && !(d.å®¢æˆ¶åç¨± || '').toLowerCase().includes(customerNameFilter)) return false;
        if (staffFilter && !(d.æ¥­å‹™äººå“¡åç¨± || d.ç¶­ä¿®äººå“¡ || d.æœå‹™äººå“¡ || '').toLowerCase().includes(staffFilter)) return false;
        if (remarksFilter && !(d.å‚™è¨» || d.ç”¢å“åç¨± || '').toLowerCase().includes(remarksFilter)) return false;
        if (phoneFilter && !(d.è¯çµ¡é›»è©± || '').toLowerCase().includes(phoneFilter)) return false;
        if (addressFilter && !(d.è¯çµ¡åœ°å€ || d.é€è²¨åœ°å€ || d.æœå‹™åœ°å€ || '').toLowerCase().includes(addressFilter)) return false;

        if (dateFromFilter || dateToFilter) {
          const itemDate = d.ç™¼è²¨æ—¥æœŸ || d.å–®æ“šæ—¥æœŸ || d.å‡ºå‹¤é–‹å§‹æ™‚é–“ || '';
          if (itemDate) {
            const parseDate = (rawDate) => {
              if (!rawDate) return null;
              let dateStr = rawDate.toString().trim().replace(/\(.+?\)/g, '');
              if (/^\d{2,3}\/\d{1,2}\/\d{1,2}/.test(dateStr)) {
                const parts = dateStr.split('/');
                return new Date(`${parseInt(parts[0], 10) + 1911}-${parts[1].padStart(2, '0')}-${parts[2].split(' ')[0].padStart(2, '0')}`);
              }
              const parsed = new Date(dateStr.replace(/\//g, '-').split(' ')[0]);
              return isNaN(parsed) ? null : parsed;
            };
            const itemDateObj = parseDate(itemDate);
            if (itemDateObj) {
              if (dateFromFilter && itemDateObj < new Date(dateFromFilter)) return false;
              if (dateToFilter && itemDateObj > new Date(dateToFilter)) return false;
            }
          }
        }
        return true;
      });
      displayResults(filteredResults);
    }

    function resetAllFilters() {
      const filters = ['typeFilter', 'docNoFilter', 'dateFromFilter', 'dateToFilter', 'customerCodeFilter', 'customerNameFilter', 'staffFilter', 'phoneFilter', 'addressFilter', 'remarksFilter', 'mobileTypeFilter', 'mobileCustomerNameFilter', 'mobileDateFromFilter', 'mobileDateToFilter'];
      filters.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
      filteredResults = [...allResults];
      displayResults(filteredResults);
    }

    function bindFilterEvents() {
      const events = ['typeFilter', 'docNoFilter', 'dateFromFilter', 'dateToFilter', 'customerCodeFilter', 'customerNameFilter', 'staffFilter', 'phoneFilter', 'addressFilter', 'remarksFilter'];
      events.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          const event = el.tagName === 'SELECT' || el.type === 'date' ? 'change' : 'keypress';
          el.addEventListener(event, (e) => { if (event === 'change' || e.key === 'Enter') applyFilters(); });
        }
      });
      document.getElementById('clearFilters')?.addEventListener('click', applyFilters);
      document.getElementById('resetFilters')?.addEventListener('click', resetAllFilters);

      const mobileEvents = ['mobileTypeFilter', 'mobileCustomerNameFilter', 'mobileDateFromFilter', 'mobileDateToFilter'];
      mobileEvents.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('change', applyFilters);
      });
      document.getElementById('mobileClearFilters')?.addEventListener('click', applyFilters);
      document.getElementById('mobileResetFilters')?.addEventListener('click', resetAllFilters);
    }

    function toNumber(val) {
      if (typeof val === 'number') return val;
      if (val == null) return 0;
      const s = String(val).replace(/[,ï¼Œ]/g, '').replace(/[^0-9.\-]/g, '');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    async function showDetails(docNo) {
      console.log('ğŸ” showDetails å‡½æ•¸è¢«èª¿ç”¨ï¼Œå–®æ“šç·¨è™Ÿï¼š', docNo);
      try {
        const res = await fetch(`/sales_info/sales_details/${docNo}`);
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        if (!data.success || !data.details) {
          alert('ç„¡æ³•ç²å–éŠ·å”®æ˜ç´°è³‡æ–™');
          return;
        }

        const total = data.details.reduce((sum, d) => sum + toNumber(d.å«ç¨…é‡‘é¡), 0);
        const container = document.createElement('div');
        container.className = 'table-responsive';

        container.innerHTML = `
          <table class="table table-sm table-bordered bg-white mb-0">
            <thead class="table-light">
              <tr>
                <th>ç”¢å“åç¨±</th>
                <th style="width: 80px;">æ•¸é‡</th>
                <th style="width: 100px;">å–®åƒ¹</th>
                <th style="width: 120px;">å«ç¨…é‡‘é¡</th>
              </tr>
            </thead>
            <tbody>
              ${data.details.map(d => `
                <tr>
                  <td>${d.ç”¢å“åç¨± || ''}</td>
                  <td class="text-end">${d.äº¤æ˜“æ•¸é‡ || 0}</td>
                  <td class="text-end">${toNumber(d.äº¤æ˜“åƒ¹).toLocaleString()}</td>
                  <td class="text-end">${toNumber(d.å«ç¨…é‡‘é¡).toLocaleString()}</td>
                </tr>
              `).join('')}
              <tr class="table-secondary fw-bold">
                <td colspan="3" class="text-end">ç¸½è¨ˆ</td>
                <td class="text-end">${total.toLocaleString()}</td>
              </tr>
            </tbody>
          </table>
        `;

        insertAfterRow(docNo, container, 'showDetails');
      } catch (error) {
        console.error('ç²å–éŠ·å”®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š', error);
        alert('ç²å–éŠ·å”®æ˜ç´°æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      }
    }

    async function showRepairDetails(docNo) {
      const res = await fetch(`/sales_info/repair_details/${docNo}`);
      const data = await res.json();
      if (data.error) return alert(data.error);
      const container = document.createElement('div');
      container.className = 'detail-container p-3 border rounded bg-light mt-2';

      // ç¢ºä¿å¾ API ç²å–çš„æ¬„ä½åç¨±èˆ‡é¡¯ç¤ºä¸€è‡´
      // æ ¹æ“š sales_info.pyï¼Œrepair.db çš„æ¬„ä½åŒ…å« å•é¡Œæè¿°, å ±ä¿®åŸå› , å ±ä¿®è™•ç†çµæœ, å®Œå·¥æƒ…æ³, å‚™è¨»
      const prob = data["å•é¡Œæè¿°"] || data["å•é¡Œæè¿°_"] || 'ç„¡';
      const reason = data["å ±ä¿®åŸå› "] || data["å ±ä¿®åŸå› _"] || 'ç„¡';
      const result = data["å ±ä¿®è™•ç†çµæœ"] || data["å ±ä¿®è™•ç†çµæœ_"] || 'ç„¡';
      const status = data["å®Œå·¥æƒ…æ³"] || data["å®Œå·¥æƒ…æ³_"] || 'ç„¡';
      const note = data["å‚™è¨»"] || data["å‚™è¨»_"] || 'ç„¡';

      container.innerHTML = `
        <h6 class="fw-bold mb-3"><i class="bi bi-tools me-2"></i>ç¶­ä¿®ç´€éŒ„ - ${docNo}</h6>
        <div class="row g-3 text-start">
          <div class="col-md-6"><strong>å•é¡Œæè¿°ï¼š</strong><p class="mb-2 small">${prob}</p></div>
          <div class="col-md-6"><strong>å ±ä¿®åŸå› ï¼š</strong><p class="mb-2 small">${reason}</p></div>
          <div class="col-md-6"><strong>è™•ç†çµæœï¼š</strong><p class="mb-2 small">${result}</p></div>
          <div class="col-md-6"><strong>å‚™è¨»ï¼š</strong><p class="mb-2 small">${note}</p></div>
          <div class="col-12"><strong>å®Œå·¥æƒ…æ³ï¼š</strong><p class="mb-0 small" style="white-space: pre-wrap;">${status}</p></div>
        </div>
      `;
      insertAfterRow(docNo, container, 'showRepairDetails');
    }

    async function showCustodyDetails(docNo) {
      const res = await fetch(`/sales_info/custody_details/${docNo}`);
      const data = await res.json();
      const container = document.createElement('div');
      container.className = 'detail-container p-3 border rounded bg-light mt-2';
      container.innerHTML = `
        <h6 class="fw-bold mb-3"><i class="bi bi-box-seam me-2"></i>å¯„å€‰å‡ºè²¨æ˜ç´° - ${docNo}</h6>
        <table class="table table-sm table-bordered bg-white">
          <thead class="table-light"><tr><th>ç”¢å“åç¨±</th><th>æ•¸é‡</th></tr></thead>
          <tbody>${data.details.map(d => `<tr><td>${d.ç”¢å“åç¨± || ''}</td><td class="text-end">${d.äº¤æ˜“æ•¸é‡ || 0}</td></tr>`).join('')}</tbody>
        </table>
      `;
      insertAfterRow(docNo, container, 'showCustodyDetails');
    }

    async function showCustomerDetails(customerCode) {
      const res = await fetch(`/sales_info/customer_details/${customerCode}`);
      const data = await res.json();
      const b = data.basic_info;
      const container = document.createElement('div');
      container.className = 'detail-container p-4 border rounded bg-light mt-2';
      container.innerHTML = `
        <h6 class="fw-bold mb-3"><i class="bi bi-person-lines-fill me-2"></i>å®¢æˆ¶è©³æƒ… - ${customerCode}</h6>
        <div class="row g-4">
          <div class="col-md-6">
            <div class="p-3 bg-white rounded border">
              <p><strong>åç¨±ï¼š</strong>${b.å®¢æˆ¶åç¨± || ''}</p>
              <p><strong>é›»è©±ï¼š</strong>${b.è¯çµ¡é›»è©± || ''}</p>
              <p><strong>åœ°å€ï¼š</strong>${b.è¯çµ¡åœ°å€ || ''}</p>
              <p><strong>æ¥­å‹™ï¼š</strong>${b.æ¥­å‹™äººå“¡åç¨± || ''}</p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 bg-white rounded border">
              <p><strong>é€è²¨åœ°å€ï¼š</strong></p>
              ${data.addresses.map(a => `<div class="small border-bottom mb-1 pb-1">${Object.values(a).join(' | ')}</div>`).join('')}
            </div>
          </div>
        </div>
      `;
      insertAfterRow(customerCode, container, 'showCustomerDetails');
    }

    function insertAfterRow(id, element, func) {
      const isMobile = window.innerWidth <= 768;
      if (isMobile) {
        const cards = document.querySelectorAll('.result-card');
        cards.forEach(card => {
          if (card.querySelector(`button[onclick^="${func}('${id}')"]`)) {
            const existing = card.querySelector('.mobile-detail-box');
            if (existing) { existing.remove(); return; }
            const box = document.createElement('div');
            box.className = 'mobile-detail-box mt-3 border-top pt-2';
            box.appendChild(element);
            card.appendChild(box);
          }
        });
      } else {
        const row = document.querySelector(`tr:has(button[onclick^="${func}('${id}')"])`);
        if (!row) return;
        if (row.nextElementSibling?.classList.contains('detail-row')) {
          row.nextElementSibling.remove();
        } else {
          const detailRow = document.createElement('tr');
          detailRow.className = 'detail-row';
          detailRow.innerHTML = `<td colspan="10" class="p-3 bg-light">${element.outerHTML}</td>`;
          row.parentNode.insertBefore(detailRow, row.nextSibling);
        }
      }
    }

    async function showServiceCard(code) {
      const res = await fetch(`/sales_info/service_card/${code}`);
      const data = await res.json();
      const win = window.open('', '_blank');
      let html = `<html><head><title>æœå‹™ç™»è¨˜å¡ - ${code}</title><link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"></head><body class="p-4"><h3>æœå‹™ç™»è¨˜å¡ - ${code}</h3>`;
      data.forEach(s => {
        html += `<div class="card mb-4"><div class="card-header bg-primary text-white">${s.main.æœå‹™ç™»è¨˜è™Ÿ}</div><div class="card-body">
          <p>å®¢æˆ¶: ${s.main.å®¢æˆ¶åç¨±} | ç”¢å“: ${s.main.ç”¢å“åç¨±} | è³¼è²·æ—¥æœŸ: ${s.main.è³¼è²·æ—¥æœŸ}</p>
          <table class="table table-sm table-bordered"><thead><tr><th>ç‰©æ–™</th><th>åç¨±</th><th>ä¸Šæ¬¡æ›´æ›</th><th>ä¸‹æ¬¡é€šçŸ¥</th></tr></thead><tbody>
          ${s.details.map(d => `<tr><td>${d.ç‰©æ–™ä»£ç¢¼}</td><td>${d.ç”¢å“åç¨±}</td><td>${d.ä¸Šæ¬¡æ›´æ›}</td><td>${d.ä¸‹æ¬¡é€šçŸ¥}</td></tr>`).join('')}
          </tbody></table></div></div>`;
      });
      win.document.write(html + '</body></html>');
      win.document.close();
    }
  </script>
</body>

</html>